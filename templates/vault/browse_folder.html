{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: var(--dawn-cream);">
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'vault_home' %}" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                        <h3 class="d-inline-block mb-0 fw-bold" style="color: var(--dawn-dark);">
                            <i class="bi bi-folder-fill" style="color: #FFC107;"></i>
                            {% if current_folder %}
                                {{ current_folder.name }}
                            {% else %}
                                My Files
                            {% endif %}
                        </h3>
                    </div>
                    <div>
                        <button class="btn btn-dawn me-2" onclick="document.getElementById('folder-file-input').click()">
                            <i class="bi bi-cloud-upload-fill"></i> Upload Here
                        </button>
                        <button class="btn btn-outline-dawn" onclick="showCreateSubfolderModal()">
                            <i class="bi bi-folder-plus"></i> New Subfolder
                        </button>
                        <input type="file" id="folder-file-input" multiple style="display: none;"
                               onchange="uploadFilesToFolder(this.files)">
                    </div>
                </div>

                <!-- Breadcrumb -->
                {% if current_folder %}
                <div class="mt-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="{% url 'vault_home' %}">Home</a>
                            </li>
                            <li class="breadcrumb-item active">{{ current_folder.name }}</li>
                        </ol>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Subfolders -->
    {% if subfolders %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-folder"></i> Folders
                </h5>
                <div class="row g-3">
                    {% for folder in subfolders %}
                    <div class="col-md-3">
                        <a href="{% url 'vault_browse_folder' folder.id %}" class="text-decoration-none">
                            <div class="p-3 folder-item" style="background: rgba(255,193,7,0.1); border-radius: 12px; border-left: 4px solid #FFC107; transition: all 0.3s; cursor: pointer;"
                                 onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)';"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-folder-fill" style="font-size: 32px; color: #FFC107;"></i>
                                        <div class="ms-3">
                                            <div class="fw-bold" style="color: var(--dawn-dark);">{{ folder.name }}</div>
                                            <small class="text-muted">{{ folder.files.count }} files</small>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right" style="color: #FFC107;"></i>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Files -->
    <div class="row">
        <div class="col-12">
            <div class="dawn-card">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-files"></i> Files ({{ files.count }})
                </h5>

                {% if files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(0,0,0,0.1);">
                                <th style="width: 50%;">Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Uploaded</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list">
                            {% for file in files %}
                            <tr class="file-row" data-file-id="{{ file.id }}" draggable="true"
                                style="cursor: move; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(255,107,53,0.05)';"
                                onmouseout="this.style.background='transparent';"
                                ondragstart="handleDragStart(event, {{ file.id }})"
                                ondragend="handleDragEnd(event)">
                                <td onclick="viewFile({{ file.id }})">
                                    <div class="d-flex align-items-center">
                                        {% if file.thumbnail %}
                                        <img src="{{ file.thumbnail.url }}" alt="{{ file.name }}"
                                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;" class="me-2">
                                        {% else %}
                                        <i class="{{ file.get_icon }}" style="font-size: 32px; color: var(--dawn-orange);" class="me-2"></i>
                                        {% endif %}
                                        <div>
                                            <div class="fw-bold">{{ file.name|truncatechars:40 }}</div>
                                            {% if file.ai_description %}
                                            <small class="text-muted">
                                                <i class="bi bi-stars"></i> {{ file.ai_description|truncatechars:50 }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>{{ file.get_file_size_display }}</td>
                                <td>
                                    <span class="badge" style="background: var(--dawn-purple); color: white;">
                                        {{ file.file_type }}
                                    </span>
                                </td>
                                <td>{{ file.uploaded_at|timesince }} ago</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-dawn" onclick="downloadFile({{ file.id }}, event)">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="moveFile({{ file.id }}, event)">
                                            <i class="bi bi-folder-symlink"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteFile({{ file.id }}, event)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.2; color: var(--dawn-orange);"></i>
                    <p class="mt-3 mb-3 h5" style="color: #999;">No files in this folder yet</p>
                    <button class="btn btn-dawn" onclick="document.getElementById('folder-file-input').click()">
                        <i class="bi bi-cloud-upload-fill"></i> Upload Files Here
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Subfolder Modal -->
<div class="modal fade" id="createSubfolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,152,0,0.1));">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-folder-plus"></i> Create Subfolder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Folder Name</label>
                    <input type="text" class="form-control" id="subfolder-name"
                           placeholder="e.g., 2024 Photos" style="border-radius: 12px;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dawn" onclick="createSubfolder()">
                    <i class="bi bi-check-lg"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let draggedFileId = null;

async function uploadFilesToFolder(files) {
    if (!files || files.length === 0) return;

    const folderId = {{ current_folder.id|default:"null" }};
    const fileArray = Array.from(files);
    let successCount = 0;
    let failCount = 0;

    console.log(`📤 Uploading ${fileArray.length} file(s) to folder ${folderId}...`);

    // Upload files sequentially to avoid race conditions
    for (let i = 0; i < fileArray.length; i++) {
        const file = fileArray[i];
        const formData = new FormData();
        formData.append('file', file);
        if (folderId) {
            formData.append('folder_id', folderId);
        }

        try {
            const response = await fetch('/vault/upload/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                successCount++;
                console.log(`✅ ${file.name} uploaded (${i + 1}/${fileArray.length})`);
            } else {
                failCount++;
                console.error(`❌ ${file.name} failed:`, data.error);
                showNotification(`❌ ${file.name}: ${data.error}`, 'error');
            }
        } catch (error) {
            failCount++;
            console.error(`❌ ${file.name} error:`, error);
            showNotification(`❌ ${file.name} upload failed`, 'error');
        }
    }

    // Show summary notification
    if (successCount > 0) {
        showNotification(`✅ Uploaded ${successCount} file${successCount > 1 ? 's' : ''} successfully!`, 'success');
    }

    // Refresh folder contents once at the end
    if (successCount > 0) {
        console.log('🔄 Refreshing folder contents...');
        await refreshFolderContents();
        console.log('✅ Folder refreshed!');
    }

    // Clear file input so the same file can be uploaded again
    const fileInput = document.getElementById('folder-file-input');
    if (fileInput) {
        fileInput.value = '';
    }
}

function viewFile(fileId) {
    window.location.href = `/vault/file/${fileId}/`;
}

function downloadFile(fileId, event) {
    event.stopPropagation();
    window.location.href = `/vault/file/${fileId}/download/`;
}

function deleteFile(fileId, event) {
    event.stopPropagation();

    if (!confirm('Delete this file?')) return;

    console.log('🗑️ Deleting file:', fileId);

    fetch(`/vault/file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(async data => {
        if (data.success) {
            showNotification('✅ File deleted!', 'success');

            // Remove file row from table with animation
            const fileRow = event.target.closest('.file-row');
            if (fileRow) {
                console.log('📌 Found file row, removing with animation...');
                fileRow.style.opacity = '0';
                fileRow.style.transform = 'scale(0.95)';
                setTimeout(async () => {
                    fileRow.remove();
                    console.log('✅ File row removed from DOM');
                    // Refresh folder contents after animation
                    await refreshFolderContents();
                }, 300);
            } else {
                console.warn('⚠️ File row not found, refreshing immediately');
                // If row not found, refresh immediately
                await refreshFolderContents();
            }
        } else {
            showNotification('❌ Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Delete error:', error);
        showNotification('❌ Failed to delete file', 'error');
    });
}

function moveFile(fileId, event) {
    event.stopPropagation();
    showNotification('💡 Tip: You can drag and drop files to move them!', 'success');
}

function showCreateSubfolderModal() {
    new bootstrap.Modal(document.getElementById('createSubfolderModal')).show();
}

async function createSubfolder() {
    const name = document.getElementById('subfolder-name').value.trim();
    const parentId = {{ current_folder.id|default:"null" }};

    if (!name) {
        showNotification('⚠️ Please enter a folder name', 'warning');
        return;
    }

    try {
        const response = await fetch('/vault/folder/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                parent_folder_id: parentId
            })
        });

        const data = await response.json();

        if (data.success) {
            showNotification('✅ Subfolder created!', 'success');

            // Hide modal and clear input
            const modal = bootstrap.Modal.getInstance(document.getElementById('createSubfolderModal'));
            if (modal) modal.hide();
            document.getElementById('subfolder-name').value = '';

            // Refresh folder contents
            console.log('🔄 Refreshing after subfolder creation...');
            await refreshFolderContents();
            console.log('✅ Folder refreshed!');
        } else {
            showNotification('❌ Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Create subfolder error:', error);
        showNotification('❌ Failed to create subfolder', 'error');
    }
}

// Refresh folder contents without page reload
async function refreshFolderContents() {
    try {
        console.log('🔄 Fetching latest folder contents from:', window.location.href);

        const response = await fetch(window.location.href, {
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Update file list (tbody)
        const fileList = document.getElementById('file-list');
        const newFileList = doc.getElementById('file-list');
        if (fileList && newFileList) {
            fileList.innerHTML = newFileList.innerHTML;
            console.log('✅ File list updated');
        } else {
            console.warn('⚠️ File list not found - possibly empty folder view');
            // Try updating the entire files card
            const filesCard = document.querySelector('.row .col-12 .dawn-card');
            const newFilesCard = doc.querySelector('.row .col-12 .dawn-card');
            if (filesCard && newFilesCard) {
                filesCard.innerHTML = newFilesCard.innerHTML;
                console.log('✅ Files card updated (entire section)');
            }
        }

        // Update subfolders section (if exists)
        const subfoldersRow = document.querySelectorAll('.row.mb-4')[1]; // Second row is subfolders
        const newSubfoldersRow = doc.querySelectorAll('.row.mb-4')[1];
        if (subfoldersRow && newSubfoldersRow) {
            subfoldersRow.innerHTML = newSubfoldersRow.innerHTML;
            console.log('✅ Subfolders section updated');
        }

        // Update file count in heading
        const filesHeading = document.querySelector('.dawn-card h5');
        const newFilesHeading = doc.querySelector('.dawn-card h5');
        if (filesHeading && newFilesHeading) {
            filesHeading.textContent = newFilesHeading.textContent;
            console.log('✅ File count updated');
        }

        console.log('✅ Folder contents refreshed successfully!');
    } catch (error) {
        console.error('❌ Failed to refresh folder contents:', error);
        showNotification('⚠️ Failed to refresh folder view', 'error');
    }
}

// Drag and Drop functionality
function handleDragStart(event, fileId) {
    draggedFileId = fileId;
    event.target.style.opacity = '0.5';
}

function handleDragEnd(event) {
    event.target.style.opacity = '1';
    draggedFileId = null;
}

// Make folders drop targets
document.addEventListener('DOMContentLoaded', function() {
    const folders = document.querySelectorAll('.folder-item');

    folders.forEach(folder => {
        folder.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.background = 'rgba(255,193,7,0.3)';
        });

        folder.addEventListener('dragleave', function() {
            this.style.background = 'rgba(255,193,7,0.1)';
        });

        folder.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.background = 'rgba(255,193,7,0.1)';

            if (draggedFileId) {
                // Get folder ID from the link href
                const folderLink = this.querySelector('a');
                const folderUrl = folderLink.getAttribute('href');
                const folderId = folderUrl.split('/').filter(x => x).pop();

                // Move file (we'll implement this endpoint)
                showNotification(`🚀 Moving file to folder... (Coming soon)`, 'success');
            }
        });
    });
});

function showNotification(message, type = 'success') {
    const colors = {
        success: '#4CAF50',
        error: '#f44336',
        warning: '#ff9800'
    };

    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 p-3 rounded-3';
    notification.style.cssText = `background: ${colors[type]}; color: white; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2);`;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
