{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <!-- Back Button -->
            <a href="{% url 'vault_home' %}" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Back to Vault
            </a>
        </div>
    </div>

    <div class="row">
        <!-- File Preview -->
        <div class="col-lg-8">
            <div class="dawn-card">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h3 class="mb-2 fw-bold" style="color: var(--dawn-dark);">
                            <i class="{{ file.get_icon }}"></i> {{ file.name }}
                        </h3>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge" style="background: var(--dawn-purple); color: white;">
                                {{ file.file_type }}
                            </span>
                            <span class="badge" style="background: #4CAF50; color: white;">
                                <i class="bi bi-lock-fill"></i> Encrypted
                            </span>
                            <small class="text-muted">{{ file.get_file_size_display }}</small>
                        </div>
                    </div>
                    <div class="btn-group">
                        <a href="{% url 'vault_download_file' file.id %}" class="btn btn-dawn">
                            <i class="bi bi-download"></i> Download
                        </a>
                        {% if is_owner %}
                        <button class="btn btn-outline-danger" onclick="deleteFile()">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- File Preview -->
                <div class="mb-4">
                    {% if file.file_type == 'image' %}
                        {% if file.thumbnail %}
                        <img src="{{ file.file.url }}" alt="{{ file.name }}"
                             style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        {% else %}
                        <div class="text-center p-5" style="background: rgba(0,0,0,0.02); border-radius: 12px;">
                            <i class="bi bi-file-earmark-image" style="font-size: 64px; color: var(--dawn-orange);"></i>
                            <p class="mt-3 text-muted">Image preview not available</p>
                        </div>
                        {% endif %}
                    {% elif file.file_type == 'video' %}
                        <video controls style="width: 100%; border-radius: 12px;">
                            <source src="{{ file.file.url }}" type="{{ file.mime_type }}">
                            Your browser does not support video playback.
                        </video>
                    {% elif file.file_type == 'audio' %}
                        <div class="p-4" style="background: rgba(0,0,0,0.02); border-radius: 12px;">
                            <audio controls style="width: 100%;">
                                <source src="{{ file.file.url }}" type="{{ file.mime_type }}">
                                Your browser does not support audio playback.
                            </audio>
                        </div>
                    {% elif file.file_type == 'document' and file.mime_type == 'application/pdf' %}
                        <iframe src="{{ file.file.url }}" style="width: 100%; height: 600px; border-radius: 12px; border: none;"></iframe>
                    {% else %}
                        <div class="text-center p-5" style="background: rgba(0,0,0,0.02); border-radius: 12px;">
                            <i class="{{ file.get_icon }}" style="font-size: 64px; color: var(--dawn-orange);"></i>
                            <p class="mt-3 text-muted">Preview not available for this file type</p>
                            <a href="{% url 'vault_download_file' file.id %}" class="btn btn-dawn mt-2">
                                <i class="bi bi-download"></i> Download to View
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- AI Description -->
                {% if file.ai_description %}
                <div class="p-3 mb-3" style="background: rgba(107,53,255,0.05); border-radius: 12px; border-left: 4px solid var(--dawn-purple);">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-stars me-2" style="font-size: 24px; color: var(--dawn-purple);"></i>
                        <div>
                            <div class="fw-bold mb-1">AI Description</div>
                            <p class="mb-0">{{ file.ai_description }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- AI Tags -->
                {% if file.ai_tags %}
                <div class="mb-3">
                    <div class="fw-bold mb-2">AI Tags:</div>
                    <div class="d-flex gap-2 flex-wrap">
                        {% for tag in file.ai_tags %}
                        <span class="badge" style="background: var(--dawn-orange); color: white; padding: 6px 12px;">
                            {{ tag }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- File Info Sidebar -->
        <div class="col-lg-4">
            <!-- File Details -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-info-circle"></i> File Details
                </h5>
                <div class="mb-2">
                    <small class="text-muted">Owner</small>
                    <div class="fw-bold">{{ file.owner.display_name }}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Size</small>
                    <div class="fw-bold">{{ file.get_file_size_display }}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Type</small>
                    <div class="fw-bold">{{ file.file_type|title }}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Uploaded</small>
                    <div class="fw-bold">{{ file.uploaded_at|date:"M d, Y" }}</div>
                    <small class="text-muted">{{ file.uploaded_at|time:"g:i A" }}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Downloads</small>
                    <div class="fw-bold">{{ file.download_count }}</div>
                </div>
                {% if file.folder %}
                <div class="mb-2">
                    <small class="text-muted">Folder</small>
                    <div class="fw-bold">
                        <i class="bi bi-folder-fill" style="color: #FFC107;"></i>
                        {{ file.folder.name }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Security Info -->
            <div class="dawn-card mb-4" style="background: linear-gradient(135deg, rgba(76,175,80,0.05), rgba(33,150,243,0.05));">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-shield-check"></i> Security
                </h5>
                <div class="mb-2 d-flex align-items-center">
                    <i class="bi bi-lock-fill me-2" style="color: #4CAF50;"></i>
                    <span>AES-256 Encrypted</span>
                </div>
                <div class="mb-2 d-flex align-items-center">
                    <i class="bi bi-hdd-fill me-2" style="color: #4CAF50;"></i>
                    <span>Stored on Black Box</span>
                </div>
                <div class="mb-2 d-flex align-items-center">
                    <i class="bi bi-shield-lock-fill me-2" style="color: #4CAF50;"></i>
                    <span>Never leaves your home</span>
                </div>
                {% if file.encryption_key_hash %}
                <div class="mt-3 p-2" style="background: rgba(0,0,0,0.05); border-radius: 8px;">
                    <small class="text-muted d-block mb-1">Encryption Hash</small>
                    <code style="font-size: 10px; word-break: break-all;">{{ file.encryption_key_hash|slice:":32" }}...</code>
                </div>
                {% endif %}
            </div>

            <!-- Sharing (if owner) -->
            {% if is_owner %}
            <div class="dawn-card">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-share"></i> Share File
                </h5>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="shareFamily"
                           {% if file.is_public_to_family %}checked{% endif %}
                           onchange="toggleFamilyShare()">
                    <label class="form-check-label" for="shareFamily">
                        Share with all family members
                    </label>
                </div>
                <button class="btn btn-outline-dawn btn-sm w-100 mt-2" onclick="createShareLink()">
                    <i class="bi bi-link-45deg"></i> Create Share Link
                </button>

                {% if share_links %}
                <div class="mt-3">
                    <small class="text-muted d-block mb-2">Active Share Links:</small>
                    {% for link in share_links %}
                    <div class="p-2 mb-2" style="background: rgba(0,0,0,0.02); border-radius: 8px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <small style="font-family: monospace;">...{{ link.share_token|slice:"-8:" }}</small>
                            <small class="text-muted">{{ link.view_count }} views</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function deleteFile() {
    if (!confirm('Are you sure you want to delete this file? This cannot be undone.')) {
        return;
    }

    fetch('/vault/file/{{ file.id }}/delete/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('âœ… File deleted successfully!', 'success');
            setTimeout(() => {
                window.location.href = '{% url "vault_home" %}';
            }, 1000);
        } else {
            showNotification('âŒ Error: ' + data.error, 'error');
        }
    });
}

function toggleFamilyShare() {
    const isShared = document.getElementById('shareFamily').checked;

    fetch('/vault/file/{{ file.id }}/toggle-share/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ share_with_family: isShared })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(isShared ? 'âœ… Shared with family!' : 'âœ… Share removed', 'success');
        }
    });
}

function createShareLink() {
    showNotification('ðŸ”— Share link feature coming soon!', 'success');
}

function showNotification(message, type = 'success') {
    const colors = {
        success: '#4CAF50',
        error: '#f44336',
        warning: '#ff9800'
    };

    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 p-3 rounded-3';
    notification.style.cssText = `background: ${colors[type]}; color: white; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2);`;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
