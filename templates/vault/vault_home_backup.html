{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: var(--dawn-cream);">

    <!-- TRUE DAPP Badge -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert text-center" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); border: none; color: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-cloud me-2"></i>
                    IPFS READY - Upload files to get decentralized CID-based storage
                    <a href="/vault/dapp/" class="btn btn-light btn-sm ms-3" style="border-radius: 15px;">
                        <i class="bi bi-arrow-right-circle"></i> Use IPFS Vault
                    </a>
                </h6>
            </div>
        </div>
    </div>

    <!-- Hero Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(107,53,255,0.1)); border: none;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2 fw-bold" style="color: var(--dawn-dark);">
                            <i class="bi bi-shield-lock-fill"></i> Family Vault
                            <span class="badge bg-primary ms-2" style="font-size: 0.6rem;">Classic Mode</span>
                        </h2>
                        <p class="mb-0" style="color: #666; font-size: 1.1rem;">
                            üí∞ <strong>Save $240/year</strong> ‚Ä¢ üè† 100% Private ‚Ä¢ ‚òÅÔ∏è Unlimited Storage on YOUR Black Box
                        </p>
                        <div class="mt-3">
                            <span class="badge" style="background: #4CAF50; color: white; padding: 8px 16px; font-size: 14px;">
                                <i class="bi bi-hdd-fill"></i> Stored locally on Black Box
                            </span>
                            <span class="badge" style="background: var(--dawn-purple); color: white; padding: 8px 16px; font-size: 14px;">
                                <i class="bi bi-lock-fill"></i> AES-256 Encrypted
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-dawn btn-lg mb-2" onclick="document.getElementById('file-input').click()">
                            <i class="bi bi-cloud-upload-fill"></i> Upload Files
                        </button>
                        <button class="btn btn-outline-dawn btn-lg mb-2" onclick="showCreateFolderModal()">
                            <i class="bi bi-folder-plus"></i> New Folder
                        </button>
                        <input type="file" id="file-input" multiple style="display: none;" onchange="uploadFiles(this.files)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Stats -->
    <div class="row mb-4 g-4">
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 glow-text fw-bold">{{ storage_used_gb }} GB</div>
                <div style="color: #666; font-weight: 500;">Storage Used</div>
                <small style="color: var(--dawn-orange);">
                    of {{ storage_quota_gb }} GB
                </small>
                <div class="mt-3">
                    <div class="progress" style="height: 10px; border-radius: 10px;">
                        <div class="progress-bar" style="width: {{ storage_percentage }}%; background: var(--dawn-orange);"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: #4CAF50;">{{ total_files }}</div>
                <div style="color: #666; font-weight: 500;">Total Files</div>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i> Safe & Encrypted
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: var(--dawn-blue);">{{ all_family_members.count }}</div>
                <div style="color: #666; font-weight: 500;">Family Members</div>
                <small style="color: var(--dawn-blue);">
                    <i class="bi bi-people-fill"></i> Sharing securely
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: #FF6B35;">$240</div>
                <div style="color: #666; font-weight: 500;">Annual Savings</div>
                <small style="color: #FF6B35;">
                    <i class="bi bi-piggy-bank-fill"></i> vs Dropbox
                </small>
            </div>
        </div>
    </div>

    <!-- Quick Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <div class="input-group input-group-lg">
                    <span class="input-group-text" style="background: white; border-right: none;">
                        <i class="bi bi-search" style="color: var(--dawn-orange);"></i>
                    </span>
                    <input type="text" class="form-control" id="search-input"
                           placeholder="ü§ñ AI-powered search... Try 'vacation photos' or 'tax documents'"
                           style="border-left: none; font-size: 1.1rem;"
                           onkeyup="debounceSearch(this.value)">
                    <button class="btn btn-dawn" onclick="performSearch()">
                        <i class="bi bi-stars"></i> AI Search
                    </button>
                </div>
                <div id="search-results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Files Area -->
        <div class="col-lg-8">
            <!-- My Files -->
            <div class="dawn-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 fw-bold" style="color: var(--dawn-dark);">
                        <i class="bi bi-files"></i> My Files
                    </h4>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewMode='grid'" id="grid-btn">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary active" onclick="viewMode='list'" id="list-btn">
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>

                <!-- Folders -->
                {% if my_folders %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-folder-fill"></i> Folders
                    </h6>
                    <div class="row g-3">
                        {% for folder in my_folders %}
                        <div class="col-md-4">
                            <a href="{% url 'vault_browse_folder' folder.id %}" class="text-decoration-none">
                                <div class="p-3" style="background: rgba(255,193,7,0.1); border-radius: 12px; border-left: 4px solid #FFC107; transition: all 0.3s;"
                                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)';"
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-folder-fill" style="font-size: 32px; color: #FFC107;"></i>
                                        <div class="ms-3">
                                            <div class="fw-bold" style="color: var(--dawn-dark);">{{ folder.name }}</div>
                                            <small class="text-muted">{{ folder.files.count }} files</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Files List -->
                <div id="files-container">
                    {% if my_files %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr style="border-bottom: 2px solid rgba(0,0,0,0.1);">
                                    <th>File</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in my_files %}
                                <tr style="cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.background='rgba(255,107,53,0.05)';"
                                    onmouseout="this.style.background='transparent';">
                                    <td onclick="viewFile({{ file.id }})">
                                        <div class="d-flex align-items-center">
                                            {% if file.thumbnail %}
                                            <img src="{{ file.thumbnail.url }}" alt="{{ file.name }}"
                                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;" class="me-2">
                                            {% else %}
                                            <i class="{{ file.get_icon }}" style="font-size: 32px; color: var(--dawn-orange);" class="me-2"></i>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold">{{ file.name|truncatechars:40 }}</div>
                                                {% if file.ai_description %}
                                                <small class="text-muted">
                                                    <i class="bi bi-stars"></i> {{ file.ai_description|truncatechars:50 }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ file.get_file_size_display }}</td>
                                    <td>
                                        <span class="badge" style="background: var(--dawn-purple); color: white;">
                                            {{ file.file_type }}
                                        </span>
                                    </td>
                                    <td>{{ file.uploaded_at|timesince }} ago</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-dawn me-1" onclick="downloadFile({{ file.id }})">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile({{ file.id }}, event)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-cloud-upload" style="font-size: 64px; opacity: 0.2; color: var(--dawn-orange);"></i>
                        <p class="mt-3 mb-3 h5" style="color: #999;">No files yet. Start by uploading!</p>
                        <button class="btn btn-dawn btn-lg" onclick="document.getElementById('file-input').click()">
                            <i class="bi bi-cloud-upload-fill"></i> Upload Your First File
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Shared with Me -->
            {% if shared_files %}
            <div class="dawn-card">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-people-fill"></i> Shared with Me
                </h5>
                <div class="row g-3">
                    {% for file in shared_files %}
                    <div class="col-md-6">
                        <div class="p-3" style="background: rgba(107,53,255,0.05); border-radius: 12px; border-left: 3px solid var(--dawn-purple);">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-bold">{{ file.name|truncatechars:25 }}</div>
                                    <small class="text-muted">by {{ file.owner.display_name }}</small>
                                </div>
                                <button class="btn btn-sm btn-dawn" onclick="downloadFile({{ file.id }})">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Family Members -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-people-fill"></i> Family Members
                </h5>
                {% for member in all_family_members %}
                <div class="d-flex align-items-center mb-3 p-2" style="background: rgba(0,0,0,0.02); border-radius: 12px;">
                    <div class="me-3">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: {{ member.avatar_color }}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                            {{ member.display_name.0 }}
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="fw-bold">{{ member.display_name }}</div>
                        <small class="text-muted">{{ member.get_storage_used_gb|floatformat:2 }} GB used</small>
                    </div>
                    <span class="badge" style="background: {{ member.role|yesno:'#4CAF50,#2196F3,#FF9800' }}; color: white;">
                        {{ member.get_role_display }}
                    </span>
                </div>
                {% endfor %}
                <a href="{% url 'vault_family_settings' %}" class="btn btn-outline-dawn btn-sm w-100 mt-2">
                    <i class="bi bi-gear"></i> Manage Family
                </a>
            </div>

            <!-- Recent Activity -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-clock-history"></i> Recent Activity
                </h5>
                {% for activity in recent_activity|slice:":5" %}
                <div class="mb-2 p-2" style="background: rgba(0,0,0,0.02); border-radius: 8px;">
                    <div class="small">
                        <strong>{{ activity.member.display_name }}</strong>
                        {{ activity.get_action_display|lower }}
                    </div>
                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                </div>
                {% empty %}
                <p class="text-muted small">No activity yet</p>
                {% endfor %}
            </div>

            <!-- Value Proposition -->
            <div class="dawn-card" style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(33,150,243,0.1));">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    üí∞ Cost Comparison
                </h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Dropbox (2TB)</span>
                        <strong style="color: #f44336;">$20/month</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Google One (2TB)</span>
                        <strong style="color: #f44336;">$10/month</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Family Vault</span>
                        <strong class="h5 mb-0" style="color: #4CAF50;">FREE</strong>
                    </div>
                </div>
                <div class="p-3" style="background: rgba(76,175,80,0.1); border-radius: 12px;">
                    <div class="text-center">
                        <div class="h3 mb-0" style="color: #4CAF50;">$240/year</div>
                        <small style="color: #666;">in savings!</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,152,0,0.1));">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-folder-plus"></i> Create New Folder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Folder Name</label>
                    <input type="text" class="form-control" id="folder-name"
                           placeholder="e.g., Family Photos, Documents" style="border-radius: 12px;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dawn" onclick="createFolder()">
                    <i class="bi bi-check-lg"></i> Create Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Progress -->
<div id="upload-progress" class="position-fixed bottom-0 end-0 m-4" style="z-index: 9999; display: none;">
    <div class="dawn-card" style="width: 350px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <h6 class="mb-3 fw-bold">
            <i class="bi bi-cloud-upload-fill"></i> Uploading Files
        </h6>
        <div class="progress mb-2" style="height: 20px; border-radius: 10px;">
            <div class="progress-bar" id="upload-progress-bar" style="background: var(--dawn-orange);"></div>
        </div>
        <div id="upload-status" class="small text-muted"></div>
    </div>
</div>

<script>
let viewMode = 'list';
let searchTimeout;

async function uploadFiles(files) {
    if (!files || files.length === 0) return;

    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('upload-progress-bar');
    const statusDiv = document.getElementById('upload-status');

    // Show progress bar
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    statusDiv.textContent = 'Starting upload...';

    let uploaded = 0;
    let failed = 0;
    const totalFiles = files.length;

    // Upload files sequentially to ensure proper tracking
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);

        try {
            statusDiv.textContent = `Uploading ${file.name}... (${i + 1}/${totalFiles})`;

            const response = await fetch('/vault/upload/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                uploaded++;
                showNotification(`‚úÖ ${file.name} uploaded!`, 'success');
            } else {
                failed++;
                showNotification(`‚ùå Failed: ${file.name} - ${data.error}`, 'error');
            }
        } catch (error) {
            failed++;
            console.error('Upload error:', error);
            showNotification(`‚ùå Upload error: ${file.name}`, 'error');
        }

        // Update progress bar after each file
        const percent = ((uploaded + failed) / totalFiles) * 100;
        progressBar.style.width = percent + '%';
        statusDiv.textContent = `${uploaded} of ${totalFiles} uploaded${failed > 0 ? ` (${failed} failed)` : ''}`;
    }

    // All uploads complete
    statusDiv.textContent = `‚úÖ Complete! ${uploaded} uploaded${failed > 0 ? `, ${failed} failed` : ''}`;

    // Wait a moment, then hide progress and refresh
    setTimeout(async () => {
        progressDiv.style.display = 'none';

        // Reset progress bar
        progressBar.style.width = '0%';
        statusDiv.textContent = '';

        // Refresh the vault display
        if (uploaded > 0) {
            console.log('Refreshing vault files and stats...');
            await refreshVaultFiles();
            await refreshVaultStats();
        }

        // Reset the file input so the same file can be uploaded again
        document.getElementById('file-input').value = '';
    }, 2000);
}

function downloadFile(fileId) {
    window.location.href = `/vault/file/${fileId}/download/`;
}

function viewFile(fileId) {
    window.location.href = `/vault/file/${fileId}/`;
}

function deleteFile(fileId, event) {
    event.stopPropagation();

    if (!confirm('Are you sure you want to delete this file?')) return;

    fetch(`/vault/file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(async data => {
        if (data.success) {
            showNotification('‚úÖ File deleted successfully!', 'success');

            // Remove file card from DOM with animation
            const fileCard = event.target.closest('.file-card');
            if (fileCard) {
                fileCard.style.opacity = '0';
                fileCard.style.transform = 'scale(0.8)';
                setTimeout(async () => {
                    fileCard.remove();

                    // Refresh both stats and files list
                    await refreshVaultStats();
                    await refreshVaultFiles();
                }, 300);
            } else {
                // If card not found, just refresh everything
                await refreshVaultStats();
                await refreshVaultFiles();
            }
        } else {
            showNotification('‚ùå Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showNotification('‚ùå Failed to delete file', 'error');
    });
}

function showCreateFolderModal() {
    new bootstrap.Modal(document.getElementById('createFolderModal')).show();
}

function createFolder() {
    const name = document.getElementById('folder-name').value.trim();

    if (!name) {
        showNotification('‚ö†Ô∏è Please enter a folder name', 'warning');
        return;
    }

    fetch('/vault/folder/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: name })
    })
    .then(response => response.json())
    .then(async data => {
        if (data.success) {
            showNotification('‚úÖ Folder created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createFolderModal')).hide();

            // Clear input
            document.getElementById('folder-name').value = '';

            // Refresh folders and files
            await refreshVaultFiles();
        } else {
            showNotification('‚ùå Error: ' + data.error, 'error');
        }
    });
}

// Refresh vault files without page reload
async function refreshVaultFiles() {
    try {
        console.log('üîÑ Refreshing vault files...');
        const response = await fetch(window.location.href, {
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Update the files container
        const filesContainer = document.getElementById('files-container');
        const newFilesContainer = doc.getElementById('files-container');
        if (filesContainer && newFilesContainer) {
            console.log('üìÅ Updating files container...');
            // Add fade effect
            filesContainer.style.opacity = '0.5';
            setTimeout(() => {
                filesContainer.innerHTML = newFilesContainer.innerHTML;
                filesContainer.style.opacity = '1';
            }, 200);
        } else {
            console.warn('‚ö†Ô∏è Files container not found');
        }

        // Update folders section if exists
        const myFilesCard = document.querySelector('.col-lg-8 .dawn-card');
        const newMyFilesCard = doc.querySelector('.col-lg-8 .dawn-card');
        if (myFilesCard && newMyFilesCard) {
            console.log('üìÇ Updating folders and files...');
            myFilesCard.innerHTML = newMyFilesCard.innerHTML;
        }

        console.log('‚úÖ Vault files refreshed successfully');
    } catch (error) {
        console.error('‚ùå Failed to refresh vault files:', error);
        // Don't show error to user, just log it
    }
}

// Refresh vault stats without page reload
async function refreshVaultStats() {
    try {
        console.log('Refreshing vault stats...');
        const response = await fetch(window.location.href, {
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Update the stats section specifically
        const statsRow = document.querySelector('.row.mb-4.g-4');
        const newStatsRow = doc.querySelector('.row.mb-4.g-4');

        if (statsRow && newStatsRow) {
            console.log('Updating stats cards...');
            // Animate the change
            statsRow.style.opacity = '0.5';
            setTimeout(() => {
                statsRow.innerHTML = newStatsRow.innerHTML;
                statsRow.style.opacity = '1';
            }, 200);
        }

        console.log('‚úÖ Vault stats refreshed successfully');
    } catch (error) {
        console.error('‚ùå Failed to refresh vault stats:', error);
        // Don't show error to user, just log it
    }
}

function debounceSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(query), 500);
}

function performSearch(query) {
    query = query || document.getElementById('search-input').value.trim();

    if (!query) {
        document.getElementById('search-results').innerHTML = '';
        return;
    }

    fetch(`/vault/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('search-results');

            if (data.results && data.results.length > 0) {
                let html = '<div class="row g-3">';
                data.results.forEach(file => {
                    html += `
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,107,53,0.05); border-radius: 12px; cursor: pointer;"
                                 onclick="viewFile(${file.id})">
                                <div class="d-flex align-items-start">
                                    <i class="${file.icon}" style="font-size: 32px; color: var(--dawn-orange);" class="me-3"></i>
                                    <div style="flex: 1;">
                                        <div class="fw-bold">${file.name}</div>
                                        <small class="text-muted">${file.size} ‚Ä¢ ${file.uploaded}</small>
                                        ${file.ai_description ? `<div class="small mt-1"><i class="bi bi-stars"></i> ${file.ai_description}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<p class="text-muted text-center">No results found</p>';
            }
        });
}

function showNotification(message, type = 'success') {
    const colors = {
        success: '#4CAF50',
        error: '#f44336',
        warning: '#ff9800'
    };

    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 p-3 rounded-3';
    notification.style.cssText = `background: ${colors[type]}; color: white; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2);`;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Drag and drop upload
const fileInput = document.getElementById('file-input');
document.body.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
});

document.body.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFiles(files);
    }
});
</script>

<style>
.glow-text {
    color: var(--dawn-orange);
    text-shadow: 0 0 10px rgba(255,107,53,0.3);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* VAULT RESPONSIVE ENHANCEMENTS */
@media (max-width: 768px) {
    /* Hero section - stack content */
    .col-md-8, .col-md-4 {
        text-align: center !important;
    }

    .text-md-end {
        text-align: center !important;
        margin-top: 16px !important;
    }

    /* Full width buttons */
    .btn-dawn, .btn-outline-dawn, .btn-group {
        width: 100% !important;
        display: flex !important;
        margin: 8px 0 !important;
    }

    .btn-dawn.btn-lg, .btn-outline-dawn.btn-lg {
        padding: 14px 20px !important;
        font-size: 1rem !important;
    }

    /* Compact hero heading */
    h2 {
        font-size: 1.75rem !important;
    }

    /* Stats cards - 2 column grid on mobile */
    .col-md-3 {
        flex: 0 0 50%;
        max-width: 50%;
    }

    .dawn-card h2 {
        font-size: 1.5rem !important;
    }

    /* Search bar */
    .input-group-lg .form-control {
        font-size: 1rem !important;
        padding: 12px !important;
    }

    .input-group-lg .btn {
        padding: 12px 16px !important;
        font-size: 0.9rem !important;
    }

    /* Folder grid - 1 column on mobile */
    .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    /* File table - hide some columns on mobile */
    .table thead th:nth-child(3),
    .table tbody td:nth-child(3),
    .table thead th:nth-child(4),
    .table tbody td:nth-child(4) {
        display: none;
    }

    /* Compact table rows */
    .table td, .table th {
        padding: 12px 8px !important;
        font-size: 0.9rem !important;
    }

    /* File name truncation */
    .fw-bold {
        font-size: 0.95rem !important;
    }

    /* Action buttons side by side */
    .table td:last-child {
        white-space: nowrap;
    }

    .btn-sm {
        padding: 6px 10px !important;
        font-size: 0.8rem !important;
    }

    /* Family members compact */
    .col-lg-4 .dawn-card {
        margin-bottom: 16px;
    }

    /* Modal responsive */
    .modal-dialog {
        margin: 16px !important;
    }
}

@media (max-width: 576px) {
    /* Extra small phones - single column stats */
    .col-md-3, .col-6 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
        margin-bottom: 12px;
    }

    h2 {
        font-size: 1.5rem !important;
    }

    .h2 {
        font-size: 1.75rem !important;
    }

    /* Compact search */
    #search-input::placeholder {
        font-size: 0.85rem !important;
    }

    /* Hide file thumbnails on very small screens */
    .table img {
        display: none;
    }

    /* Compact upload progress */
    #upload-progress {
        width: calc(100vw - 32px) !important;
        margin: 16px !important;
    }
}

/* Tablet optimizations */
@media (min-width: 769px) and (max-width: 991px) {
    .col-lg-8, .col-lg-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    /* 2-column folder grid on tablet */
    .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

/* Improve touch targets */
@media (hover: none) and (pointer: coarse) {
    .btn, button, a {
        min-height: 44px;
        min-width: 44px;
    }

    .table tr {
        cursor: pointer;
    }
}
</style>

{% endblock %}
