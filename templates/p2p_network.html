{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: var(--dawn-cream);">
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2 fw-bold" style="color: var(--dawn-dark);">
                            <i class="bi bi-diagram-3"></i> Decentralized Knowledge Network
                        </h2>
                        <p class="mb-0" style="color: #666;">
                            üåê True P2P ‚Ä¢ üîê End-to-End Encrypted ‚Ä¢ ü§ù Zero Trust Architecture
                        </p>
                        <div class="mt-2">
                            <span class="badge"
                                style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 16px;">
                                <i class="bi bi-circle-fill" style="font-size: 8px; animation: pulse 2s infinite;"></i>
                                Your Node: <code style="color: white;">{{ node.node_id|slice:":12" }}...</code>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-dawn mb-2" onclick="showShareModal()">
                            <i class="bi bi-share"></i> Share Knowledge
                        </button>
                        <button class="btn btn-outline-dawn mb-2" onclick="discoverNodes()">
                            <i class="bi bi-radar"></i> Discover Nodes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <h4 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-diagram-3-fill"></i> Network Topology
                </h4>
                <div id="network-graph"
                    style="height: 300px; background: #000; border-radius: 12px; position: relative; overflow: hidden;">
                    <!-- Network visualization will be drawn here -->
                    <canvas id="network-canvas"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small style="color: #666;">
                        <i class="bi bi-info-circle"></i>
                        Live P2P mesh network showing Black Box connections
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Stats -->
    <div class="row mb-4 g-4">
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 glow-text fw-bold">{{ total_nodes }}</div>
                <div style="color: #666; font-weight: 500;">Active Nodes</div>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i> Live on network
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: var(--dawn-purple);">{{ my_shared_knowledge }}</div>
                <div style="color: #666; font-weight: 500;">Shared by You</div>
                <small style="color: var(--dawn-purple);">
                    <i class="bi bi-box-seam"></i> In network
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: var(--dawn-blue);">{{ received_knowledge }}</div>
                <div style="color: #666; font-weight: 500;">Downloaded</div>
                <small style="color: var(--dawn-blue);">
                    <i class="bi bi-download"></i> Cached locally
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: #4CAF50;">{{ active_connections }}</div>
                <div style="color: #666; font-weight: 500;">P2P Links</div>
                <small class="text-success">
                    <i class="bi bi-link-45deg"></i> Encrypted
                </small>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Public Knowledge Network -->
        <div class="col-lg-8">
            <div class="dawn-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0 fw-bold" style="color: var(--dawn-dark);">
                        <i class="bi bi-globe2"></i> Decentralized Knowledge Pool
                    </h4>
                    <div>
                        <select class="form-select form-select-sm" id="category-filter" onchange="filterKnowledge()"
                            style="border-radius: 12px; border: 2px solid rgba(0,0,0,0.1);">
                            <option value="all">All Categories</option>
                            <option value="technology">Technology</option>
                            <option value="science">Science</option>
                            <option value="education">Education</option>
                            <option value="privacy">Privacy & Security</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                </div>

                <div class="knowledge-grid" id="knowledge-grid">
                    {% for knowledge in public_knowledge %}
                    <div class="knowledge-card p-3 mb-3" data-category="{{ knowledge.category }}" style="background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05)); 
                                border-radius: 16px; border-left: 4px solid var(--dawn-orange);
                                transition: all 0.3s ease;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div style="flex: 1;">
                                <h6 class="mb-1 fw-bold" style="color: var(--dawn-dark);">
                                    <i class="bi bi-file-earmark-lock"></i> {{ knowledge.title }}
                                </h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <span class="badge"
                                        style="background: var(--dawn-purple); color: white; font-size: 10px;">
                                        {{ knowledge.category }}
                                    </span>
                                    <span class="badge"
                                        style="background: rgba(0,0,0,0.1); color: #666; font-size: 10px;">
                                        üîê Encrypted
                                    </span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-1">
                                    <small class="badge" style="background: #4CAF50; color: white; font-size: 9px;">
                                        Rep: {{ knowledge.shared_by.reputation_score }}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <p class="mb-2 small" style="color: #666;">
                            <i class="bi bi-person-badge"></i> Node:
                            <code>{{ knowledge.shared_by.node_id|slice:":8" }}...</code>
                        </p>

                        <div class="d-flex justify-content-between align-items-center">
                            <small style="color: #999;">
                                <i class="bi bi-download"></i> {{ knowledge.downloads }} ‚Ä¢
                                <i class="bi bi-hand-thumbs-up"></i> {{ knowledge.upvotes }} ‚Ä¢
                                <i class="bi bi-clock"></i> {{ knowledge.created_at|timesince }} ago
                            </small>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-1"
                                    onclick="upvoteKnowledge({{ knowledge.id }})">
                                    <i class="bi bi-hand-thumbs-up"></i>
                                </button>
                                <button class="btn btn-sm btn-dawn" onclick="downloadKnowledge({{ knowledge.id }})">
                                    <i class="bi bi-download"></i> Get
                                </button>
                            </div>
                        </div>

                        <!-- Encryption indicator -->
                        <div class="mt-2 p-2" style="background: rgba(76,175,80,0.05); border-radius: 8px;">
                            <small style="color: #4CAF50; font-size: 10px;">
                                <i class="bi bi-shield-lock-fill"></i>
                                End-to-end encrypted transfer ‚Ä¢ Hash:
                                <code>{{ knowledge.encryption_key_hash|slice:":8" }}...</code>
                            </small>
                        </div>
                        <!-- Blockchain indicator (show if wallet connected) -->
                        <!-- Add after encryption indicator in knowledge card -->
                        {% if knowledge.blockchain_tx %}
                        <div class="mt-2 p-2" style="background: rgba(107,53,255,0.05); border-radius: 8px;">
                            <small style="color: var(--dawn-purple); font-size: 10px;">
                                <i class="bi bi-link-45deg"></i>
                                Recorded on Solana ‚Ä¢
                                <a href="https://explorer.solana.com/tx/{{ knowledge.blockchain_tx }}?cluster=devnet"
                                    target="_blank" style="color: var(--dawn-purple);">
                                    View TX
                                </a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.2; color: var(--dawn-dark);"></i>
                        <p class="mt-3 mb-3" style="color: #999;">No knowledge in the network yet</p>
                        <button class="btn btn-dawn" onclick="showShareModal()">
                            <i class="bi bi-plus-circle"></i> Be the first to share!
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Your Shared Knowledge -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-box-seam"></i> Your Contributions
                </h5>
                {% for knowledge in my_knowledge %}
                <div class="p-3 mb-2"
                    style="background: rgba(255,107,53,0.05); border-radius: 12px; border-left: 3px solid var(--dawn-orange);">
                    <div class="fw-bold small mb-1">{{ knowledge.title|truncatechars:30 }}</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small style="color: #999;">
                            <i class="bi bi-download"></i> {{ knowledge.downloads }} downloads
                        </small>
                        <span class="badge"
                            style="background: {{ knowledge.is_public|yesno:'#4CAF50,#ff9800' }}; color: white; font-size: 9px;">
                            {{ knowledge.is_public|yesno:'Public,Private' }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="bi bi-box" style="font-size: 32px; opacity: 0.2;"></i>
                    <p class="small mt-2 mb-0" style="color: #999;">No knowledge shared yet</p>
                </div>
                {% endfor %}
            </div>

            <!-- Connected Nodes -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-diagram-3"></i> Mesh Network
                </h5>
                <div class="mb-3 p-2" style="background: rgba(76,175,80,0.05); border-radius: 8px;">
                    <small class="text-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Peer-to-Peer Mode:</strong> Direct connections
                    </small>
                </div>
                {% for connected_node in connected_nodes %}
                <div class="d-flex align-items-center mb-2 p-2"
                    style="background: rgba(0,0,0,0.02); border-radius: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,107,53,0.1)'"
                    onmouseout="this.style.background='rgba(0,0,0,0.02)'">
                    <div class="me-2">
                        <span class="badge bg-success"
                            style="width: 12px; height: 12px; border-radius: 50%; padding: 0; animation: pulse 2s infinite;"></span>
                    </div>
                    <div style="flex: 1;">
                        <div class="small fw-bold">
                            <i class="bi bi-hdd-network"></i> {{ connected_node.node_id|slice:":12" }}...
                        </div>
                        <small style="color: #999;">
                            Trust: {{ connected_node.reputation_score }}/100
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                        onclick="connectToNode('{{ connected_node.node_id }}')"
                        style="font-size: 10px; padding: 4px 8px; border-radius: 8px;">
                        <i class="bi bi-link-45deg"></i>
                    </button>
                </div>
                {% empty %}
                <div class="text-center py-3">
                    <i class="bi bi-diagram-3" style="font-size: 32px; opacity: 0.2;"></i>
                    <p class="small mt-2 mb-2" style="color: #999;">No connections yet</p>
                    <button class="btn btn-sm btn-dawn" onclick="discoverNodes()">
                        <i class="bi bi-radar"></i> Discover
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- Network Stats -->
            <div class="dawn-card"
                style="background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05));">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-graph-up"></i> Network Health
                </h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small style="color: #666;">Node Reputation</small>
                        <small class="fw-bold" style="color: var(--dawn-orange);">
                            {{ node.reputation_score }}/100
                        </small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(0,0,0,0.1);">
                        <div class="progress-bar"
                            style="width: {{ node.reputation_score }}%; background: var(--dawn-orange);"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small style="color: #666;">Network Coverage</small>
                        <small class="fw-bold" style="color: #4CAF50;">
                            {{ active_connections }}/10
                        </small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(0,0,0,0.1);">
                        <div class="progress-bar bg-success"
                            style="width: {% if active_connections > 0 %}{{ active_connections }}0{% else %}5{% endif %}%;">
                        </div>
                    </div>
                </div>
                <div class="p-2" style="background: rgba(0,0,0,0.05); border-radius: 8px;">
                    <small style="color: #666;">
                        <i class="bi bi-shield-check"></i> All transfers encrypted with RSA-2048
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Knowledge Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header"
                style="border-bottom: 1px solid rgba(0,0,0,0.05); background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05));">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-share"></i> Share Knowledge to P2P Network
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3"
                    style="border-radius: 12px; border-left: 4px solid var(--dawn-blue);">
                    <small>
                        <strong><i class="bi bi-info-circle"></i> How it works:</strong><br>
                        Your knowledge will be encrypted and broadcast to all connected Black Box nodes in the mesh
                        network.
                    </small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Title</label>
                    <input type="text" class="form-control" id="knowledge-title"
                        placeholder="e.g., Best practices for secure AI deployment" style="border-radius: 12px;">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Content</label>
                    <textarea class="form-control" id="knowledge-content" rows="6" placeholder="Share your knowledge..."
                        style="border-radius: 12px;"></textarea>
                    <small style="color: #666;">
                        <i class="bi bi-lock-fill"></i> Will be encrypted before transmission
                    </small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <select class="form-select" id="knowledge-category" style="border-radius: 12px;">
                        <option value="general">General</option>
                        <option value="technology">Technology</option>
                        <option value="science">Science</option>
                        <option value="education">Education</option>
                        <option value="privacy">Privacy & Security</option>
                    </select>
                </div>
                <div class="form-check p-3" style="background: rgba(76,175,80,0.05); border-radius: 12px;">
                    <input class="form-check-input" type="checkbox" id="knowledge-public" checked>
                    <label class="form-check-label fw-bold" for="knowledge-public">
                        <i class="bi bi-globe"></i> Broadcast to public P2P network
                    </label>
                    <br>
                    <small style="color: #666;">Uncheck for private sharing only</small>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0,0,0,0.05);">
                <button type="button" class="btn btn-outline-dawn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dawn" onclick="shareKnowledge()">
                    <i class="bi bi-broadcast"></i> Broadcast to Network
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // IMPRESSIVE ANIMATED P2P NETWORK VISUALIZATION
    // ========================================================
    const canvas = document.getElementById('network-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.parentElement.offsetWidth;
    canvas.height = 300;

    // Network nodes with animation
    const nodes = [];
    const centerNode = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 20,
        color: '#FF6B35',
        label: 'YOU',
        pulsePhase: 0
    };

    // ‚úÖ TRUE DAPP: No demo nodes!
    // Nodes only appear when REAL peers connect via WebRTC
    // Empty initially - will populate when peers discover each other

    // Data packets flying between nodes
    let dataPackets = [];
    function createDataPacket(fromNode, toNode) {
        dataPackets.push({
            startX: fromNode.x,
            startY: fromNode.y,
            endX: toNode.x,
            endY: toNode.y,
            progress: 0,
            speed: 0.02,
            color: '#00F0FF'
        });
    }

    // Animation loop
    function animate() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw connections with glow
        nodes.forEach(node => {
            ctx.strokeStyle = 'rgba(76, 175, 80, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(centerNode.x, centerNode.y);
            ctx.lineTo(node.x, node.y);
            ctx.stroke();
        });

        // Update and draw data packets
        dataPackets = dataPackets.filter(packet => {
            packet.progress += packet.speed;
            if (packet.progress > 1) return false;

            const x = packet.startX + (packet.endX - packet.startX) * packet.progress;
            const y = packet.startY + (packet.endY - packet.startY) * packet.progress;

            // Draw glowing packet
            ctx.shadowBlur = 15;
            ctx.shadowColor = packet.color;
            ctx.fillStyle = packet.color;
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            return true;
        });

        // Animate peer nodes (gentle floating)
        nodes.forEach(node => {
            node.x += node.velocityX;
            node.y += node.velocityY;

            // Bounce off edges
            if (node.x < 50 || node.x > canvas.width - 50) node.velocityX *= -1;
            if (node.y < 50 || node.y > canvas.height - 50) node.velocityY *= -1;

            // Keep within bounds
            node.x = Math.max(50, Math.min(canvas.width - 50, node.x));
            node.y = Math.max(50, Math.min(canvas.height - 50, node.y));

            // New node entrance effect
            if (node.isNew) {
                if (!node.growPhase) node.growPhase = 0;
                node.growPhase += 0.05;
                if (node.growPhase >= 1) {
                    node.isNew = false; // Entrance complete
                }
            }
            const growScale = node.isNew ? node.growPhase : 1;

            // Draw node with pulse
            node.pulsePhase += 0.05;
            const pulse = Math.sin(node.pulsePhase) * 2;

            // Extra glow for new nodes
            const extraGlow = node.isNew ? 20 : 0;

            ctx.shadowBlur = 10 + pulse + extraGlow;
            ctx.shadowColor = node.isNew ? '#00F0FF' : node.color;
            ctx.fillStyle = node.isNew ? '#00F0FF' : node.color;
            ctx.beginPath();
            ctx.arc(node.x, node.y, (node.radius + pulse) * growScale, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Node label
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 8px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(node.isNew ? 'NEW!' : 'NODE', node.x, node.y + 3);
        });

        // Draw center node (YOU) with extra glow
        centerNode.pulsePhase += 0.03;
        const centerPulse = Math.sin(centerNode.pulsePhase) * 3;

        ctx.shadowBlur = 20 + centerPulse;
        ctx.shadowColor = centerNode.color;
        ctx.fillStyle = centerNode.color;
        ctx.beginPath();
        ctx.arc(centerNode.x, centerNode.y, centerNode.radius + centerPulse, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Center node label
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(centerNode.label, centerNode.x, centerNode.y + 4);

        // Stats overlay
        ctx.fillStyle = 'rgba(0, 255, 100, 0.8)';
        ctx.font = 'bold 10px monospace';
        ctx.textAlign = 'left';
        ctx.fillText(`‚ö° LIVE MESH NETWORK ‚Ä¢ ${nodeCount} NODES ONLINE`, 10, 20);

        requestAnimationFrame(animate);
    }

    // Start animation
    animate();

    // Periodically send data packets
    setInterval(() => {
        if (nodes.length > 0) {
            const randomNode = nodes[Math.floor(Math.random() * nodes.length)];
            createDataPacket(centerNode, randomNode);
        }
    }, 1000);

    // Redraw on window resize
    window.addEventListener('resize', () => {
        canvas.width = canvas.parentElement.offsetWidth;
        centerNode.x = canvas.width / 2;
        centerNode.y = canvas.height / 2;
    });

    function showShareModal() {
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    }

    async function shareKnowledge() {
    const title = document.getElementById('knowledge-title').value;
    const content = document.getElementById('knowledge-content').value;
    const category = document.getElementById('knowledge-category').value;
    const isPublic = document.getElementById('knowledge-public').checked;

    if (!title || !content) {
        showNotification('‚ö†Ô∏è Please fill in all fields', 'warning');
        return;
    }

    // ‚úÖ BLOCKCHAIN REQUIRED - Wallet MUST be connected
    if (!window.solana || !window.solana.isConnected) {
        showNotification('üîó Blockchain Required: Please connect your Solana wallet to share on P2P network', 'error');

        // Try to connect wallet
        try {
            await window.solana.connect();
        } catch (err) {
            showNotification('‚ùå Wallet connection required. Install Phantom wallet to participate in P2P network.', 'error');
            return;
        }
    }

    // Check if Solana Web3 is loaded
    if (!window.solanaWeb3) {
        showNotification('‚ùå Solana Web3 library not loaded. Please refresh the page.', 'error');
        console.error('window.solanaWeb3 is undefined');
        return;
    }

    // Check wallet balance (need SOL for transaction fees)
    try {
        const connection = new window.solanaWeb3.Connection('https://api.devnet.solana.com', 'confirmed');
        const balance = await connection.getBalance(window.solana.publicKey);
        console.log(`üí∞ Wallet balance: ${balance / 1e9} SOL`);

        if (balance === 0) {
            showNotification('‚ö†Ô∏è No devnet SOL found! Get free devnet SOL from: https://faucet.solana.com/', 'warning');
            // Open faucet in new tab
            window.open(`https://faucet.solana.com/?address=${window.solana.publicKey.toString()}`, '_blank');
            return;
        }
    } catch (balanceError) {
        console.warn('Could not check balance:', balanceError);
        // Continue anyway - balance check is not critical
    }

    showNotification('üîê Encrypting content...', 'success');

    try {
        // Step 1: Create knowledge entry
        const response = await fetch('/p2p/share/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content: content,
                category: category,
                is_public: isPublic
            })
        });

        const data = await response.json();

        if (data.success) {
            showNotification('‚úÖ Knowledge saved locally', 'success');
            
            // Step 2: Create REAL Solana transaction
            showNotification('üìù Creating Solana transaction...', 'success');
            
            try {
                const memoData = data.message_to_sign || JSON.stringify({
                    knowledge_id: data.knowledge_id,
                    title: title,
                    category: category
                });
                
                // Create Solana transaction with Memo Program
                const transaction = await createSolanaMemoTransaction(memoData);
                
                showNotification('‚úçÔ∏è Please APPROVE in Phantom wallet...', 'success');
                
                // Sign and send transaction to Solana
                const { signature } = await window.solana.signAndSendTransaction(transaction);
                
                showNotification(`‚è≥ Transaction sent! Signature: ${signature.slice(0,8)}...`, 'success');
                showNotification('‚è≥ Waiting for Solana confirmation (15 seconds)...', 'success');
                
                // Wait for confirmation (Solana takes 10-15 seconds)
                await new Promise(resolve => setTimeout(resolve, 15000));
                
                // Step 3: Verify on backend
                const confirmResponse = await fetch('/p2p/confirm-blockchain/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        knowledge_id: data.knowledge_id,
                        signature: signature,
                        transaction_data: data.transaction_data
                    })
                });

                const confirmData = await confirmResponse.json();

                if (confirmData.success) {
                    showNotification(`‚úÖ VERIFIED on Solana blockchain!`, 'success');
                    
                    // Show success modal
                    showBlockchainConfirmation({
                        tx_signature: signature,
                        explorer_url: `https://explorer.solana.com/tx/${signature}?cluster=devnet`,
                        title: title,
                        category: category,
                        ...confirmData.tx_details
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();

                    // Refresh knowledge grid instead of full page reload
                    setTimeout(() => refreshKnowledgeGrid(), 1000);
                    
                } else {
                    showNotification('‚ö†Ô∏è Verification pending. Knowledge saved locally.', 'warning');
                    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();

                    // Refresh knowledge grid instead of full page reload
                    setTimeout(() => refreshKnowledgeGrid(), 1000);
                }
                
            } catch (walletError) {
                console.error('‚ùå Wallet/Transaction error:', walletError);
                console.error('Error details:', {
                    message: walletError.message,
                    name: walletError.name,
                    stack: walletError.stack
                });

                // Show detailed error message
                let errorMsg = '‚ùå Transaction failed: ';
                if (walletError.message) {
                    errorMsg += walletError.message;
                } else if (walletError.toString) {
                    errorMsg += walletError.toString();
                } else {
                    errorMsg += 'Unknown error. Check browser console for details.';
                }

                showNotification(errorMsg, 'error');

                // Delete the knowledge entry that was created
                fetch(`/p2p/delete-knowledge/${data.knowledge_id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                }).catch(err => console.error('Cleanup error:', err));

                bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
            }
        } else {
            showNotification('‚ùå Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Share error:', error);
        showNotification('‚ùå Error: ' + error.message, 'error');
    }
}

// Helper: Create REAL Solana Memo Transaction
async function createSolanaMemoTransaction(memoData) {
    const { Connection, Transaction, TransactionInstruction, PublicKey } = window.solanaWeb3;

    // Connect to Solana Devnet
    const connection = new Connection('https://api.devnet.solana.com', 'confirmed');
    const walletPublicKey = window.solana.publicKey;

    // Convert string to Uint8Array (browser-compatible, no Buffer needed)
    const encoder = new TextEncoder();
    const dataBytes = encoder.encode(memoData);

    // Create Memo instruction (Memo Program stores data on-chain)
    const memoInstruction = new TransactionInstruction({
        keys: [{ pubkey: walletPublicKey, isSigner: true, isWritable: false }],
        programId: new PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'), // Solana Memo Program
        data: dataBytes
    });

    // Create transaction
    const transaction = new Transaction().add(memoInstruction);
    transaction.feePayer = walletPublicKey;

    // Get recent blockhash
    const { blockhash } = await connection.getLatestBlockhash();
    transaction.recentBlockhash = blockhash;

    console.log('‚úÖ Transaction created successfully');
    console.log('Memo data length:', dataBytes.length, 'bytes');

    return transaction;
}

    async function downloadKnowledge(knowledgeId) {
        showNotification('üîê Establishing encrypted P2P connection...', 'success');

        try {
            const response = await fetch(`/p2p/download/${knowledgeId}/`);
            const data = await response.json();

            if (data.success) {
                showNotification('‚úÖ Knowledge downloaded via encrypted P2P transfer!', 'success');

                // Display downloaded content
                const modal = document.createElement('div');
                modal.innerHTML = `
                <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.7);">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(107,53,255,0.1));">
                                <h5 class="modal-title fw-bold">
                                    <i class="bi bi-file-earmark-lock"></i> ${escapeHtml(data.title)}
                                </h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <span class="badge" style="background: var(--dawn-purple);">${data.category}</span>
                                    <span class="badge bg-secondary">From: ${data.shared_by}</span>
                                    <span class="badge" style="background: #4CAF50;">
                                        <i class="bi bi-shield-check"></i> Decrypted
                                    </span>
                                </div>
                                <div style="white-space: pre-wrap; padding: 20px; background: #F5F5F5; border-radius: 12px; max-height: 400px; overflow-y: auto;">${escapeHtml(data.content)}</div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-dawn" onclick="copyToClipboard(\`${escapeHtml(data.content).replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                    <i class="bi bi-clipboard"></i> Copy Content
                                </button>
                                <button class="btn btn-outline-dawn" onclick="this.closest('.modal').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Network error: ' + error.message, 'error');
        }
    }

    async function upvoteKnowledge(knowledgeId) {
        try {
            const response = await fetch(`/p2p/upvote/${knowledgeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification('üëç Upvoted! Reputation increased.', 'success');

                // Update vote count in UI without reload
                const voteBtn = event.target.closest('.btn');
                if (voteBtn) {
                    const currentCount = parseInt(voteBtn.textContent.match(/\d+/)?.[0] || 0);
                    voteBtn.innerHTML = `<i class="bi bi-arrow-up-circle-fill"></i> ${currentCount + 1} votes`;
                    voteBtn.disabled = true;
                    voteBtn.style.opacity = '0.6';
                }
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Error: ' + error.message, 'error');
        }
    }

    function discoverNodes() {
        showNotification('üîç Scanning for REAL P2P nodes via WebRTC...', 'success');

        // ‚úÖ TRUE DAPP: Discover real peers via Gun.js
        if (!window.dawnguardGun) {
            showNotification('‚ö†Ô∏è Gun.js not initialized. Enable P2P database first.', 'warning');
            return;
        }

        const myAddress = window.solana?.publicKey?.toString() || 'anonymous_' + Date.now();

        // Announce yourself
        window.dawnguardGun.get('dawnguard').get('peers').get(myAddress).put({
            online: true,
            timestamp: Date.now(),
            lastSeen: Date.now()
        });

        // Listen for other peers
        let discoveredCount = 0;
        window.dawnguardGun.get('dawnguard').get('peers').map().once((peerData, address) => {
            if (address !== myAddress && peerData && peerData.online) {
                // Check if peer is recent (within 5 minutes)
                if (Date.now() - peerData.lastSeen < 300000) {
                    // Add to mesh visualization
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 100 + Math.random() * 40;

                    // Check if peer already exists
                    const exists = nodes.find(n => n.peerId === address);
                    if (!exists) {
                        nodes.push({
                            x: centerNode.x + Math.cos(angle) * distance,
                            y: centerNode.y + Math.sin(angle) * distance,
                            radius: 12,
                            color: '#4CAF50',
                            velocityX: (Math.random() - 0.5) * 0.5,
                            velocityY: (Math.random() - 0.5) * 0.5,
                            pulsePhase: Math.random() * Math.PI * 2,
                            isNew: true,
                            peerId: address
                        });
                        discoveredCount++;
                    }
                }
            }
        });

        setTimeout(() => {
            if (discoveredCount > 0) {
                showNotification(`‚úÖ Discovered ${discoveredCount} REAL peer${discoveredCount > 1 ? 's' : ''}!`, 'success');
                document.querySelector('.glow-text').textContent = nodes.length + 1;
            } else {
                showNotification('No other peers online. Deploy on another Black Box to see P2P mesh!', 'info');
            }
        }, 2000);
    }

    async function connectToNode(nodeId) {
        showNotification('ü§ù Establishing encrypted P2P connection...', 'success');

        try {
            const response = await fetch(`/p2p/connect/${nodeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification('‚úÖ ' + data.message, 'success');

                // Refresh knowledge grid instead of full page reload
                setTimeout(() => refreshKnowledgeGrid(), 500);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Error: ' + error.message, 'error');
        }
    }

    // Refresh knowledge grid without breaking canvas animation
    async function refreshKnowledgeGrid() {
        try {
            console.log('üîÑ Refreshing knowledge grid (preserving canvas)...');
            const response = await fetch(window.location.href, {
                headers: { 'Cache-Control': 'no-cache' }
            });
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Update ONLY the knowledge cards section (not network visualization!)
            // Find the knowledge cards container - it's the last .row.g-4
            const allGrids = document.querySelectorAll('.row.g-4');
            const knowledgeGrid = allGrids[allGrids.length - 1]; // Last one is knowledge cards

            const allNewGrids = doc.querySelectorAll('.row.g-4');
            const newKnowledgeGrid = allNewGrids[allNewGrids.length - 1];

            if (knowledgeGrid && newKnowledgeGrid) {
                console.log('üì¶ Updating knowledge cards...');
                knowledgeGrid.innerHTML = newKnowledgeGrid.innerHTML;
            }

            // Update stats numbers only (not entire cards - preserve network viz)
            const statNumbers = document.querySelectorAll('.row.mb-4.g-4 .h2');
            const newStatNumbers = doc.querySelectorAll('.row.mb-4.g-4 .h2');
            for (let i = 0; i < Math.min(statNumbers.length, newStatNumbers.length); i++) {
                if (statNumbers[i] && newStatNumbers[i]) {
                    statNumbers[i].textContent = newStatNumbers[i].textContent;
                }
            }

            console.log('‚úÖ Knowledge grid refreshed (canvas preserved)');
        } catch (error) {
            console.error('‚ùå Failed to refresh knowledge grid:', error);
        }
    }

    function filterKnowledge() {
        const filter = document.getElementById('category-filter').value;
        const cards = document.querySelectorAll('.knowledge-card');

        cards.forEach(card => {
            if (filter === 'all' || card.dataset.category === filter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function copyToClipboard(text) {
        // Remove HTML entities and clean text
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        const cleanText = tempDiv.textContent || tempDiv.innerText || '';

        navigator.clipboard.writeText(cleanText).then(() => {
            showNotification('üìã Copied to clipboard!', 'success');
        }).catch(err => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = cleanText;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('üìã Copied to clipboard!', 'success');
            } catch (err) {
                showNotification('‚ùå Failed to copy', 'error');
            }
            document.body.removeChild(textArea);
        });
    }

    function showNotification(message, type = 'success') {
        const colors = {
            success: '#4CAF50',
            error: '#f44336',
            warning: '#ff9800'
        };

        const notification = document.createElement('div');
        notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3';
        notification.style.cssText = `background: ${colors[type]}; color: white; border-radius: 16px; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2); animation: slideIn 0.3s;`;
        notification.innerHTML = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showBlockchainConfirmation(data) {
        /**
         * Show blockchain confirmation modal with transaction details
         */
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.8);" id="blockchainConfirmModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="border-radius: 20px; border: 2px solid #4CAF50;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; border-radius: 18px 18px 0 0;">
                            <h5 class="modal-title fw-bold">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Blockchain Verified!
                            </h5>
                            <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('blockchainConfirmModal').remove()"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="text-center mb-4">
                                <div style="font-size: 64px; animation: bounce 2s infinite;">‚úÖ</div>
                                <h4 class="fw-bold mt-3" style="color: #4CAF50;">Transaction Confirmed on Solana</h4>
                                <p class="text-muted">Your knowledge has been permanently recorded on the blockchain</p>
                            </div>

                            <div class="card mb-3" style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(255,255,255,0.5)); border: 2px solid rgba(76,175,80,0.3); border-radius: 15px;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3"><i class="bi bi-file-earmark-text me-2"></i>Knowledge Details</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Title</small>
                                            <strong>${escapeHtml(data.title || 'N/A')}</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Category</small>
                                            <span class="badge" style="background: var(--dawn-purple); color: white;">${escapeHtml(data.category || 'General')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3" style="background: linear-gradient(135deg, rgba(107,53,255,0.1), rgba(255,255,255,0.5)); border: 2px solid rgba(107,53,255,0.3); border-radius: 15px;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3"><i class="bi bi-shield-check me-2"></i>Blockchain Details</h6>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Transaction Signature</small>
                                        <code style="font-size: 0.85rem; word-break: break-all;">${data.tx_signature || 'N/A'}</code>
                                    </div>
                                    <div class="row g-2 mt-2">
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Block Time</small>
                                            <strong>${data.block_time ? new Date(data.block_time * 1000).toLocaleString() : 'Pending'}</strong>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Slot</small>
                                            <strong>${data.slot || 'N/A'}</strong>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Fee</small>
                                            <strong>${data.fee ? (data.fee / 1e9).toFixed(6) : '0.000005'} SOL</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <a href="${data.explorer_url || '#'}" target="_blank" class="btn btn-lg" style="background: linear-gradient(135deg, var(--dawn-purple), #8b5aff); color: white; border-radius: 15px; font-weight: 600;">
                                    <i class="bi bi-box-arrow-up-right me-2"></i>
                                    View on Solana Explorer
                                </a>
                                <button class="btn btn-outline-secondary" onclick="document.getElementById('blockchainConfirmModal').remove()" style="border-radius: 15px;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Remove modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Animate network connections periodically
    setInterval(() => {
        const connections = document.querySelectorAll('.badge.bg-success');
        connections.forEach(conn => {
            conn.style.animation = 'none';
            setTimeout(() => {
                conn.style.animation = 'pulse 2s infinite';
            }, 10);
        });
    }, 5000);
</script>

<style>
    .knowledge-card {
        transition: all 0.3s ease;
    }

    .knowledge-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-left-width: 6px !important;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    #network-canvas {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}