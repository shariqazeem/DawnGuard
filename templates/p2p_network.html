{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: var(--dawn-cream);">
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2 fw-bold" style="color: var(--dawn-dark);">
                            <i class="bi bi-diagram-3"></i> Decentralized Knowledge Network
                        </h2>
                        <p class="mb-0" style="color: #666;">
                            üåê True P2P ‚Ä¢ üîê End-to-End Encrypted ‚Ä¢ ü§ù Zero Trust Architecture
                        </p>
                        <div class="mt-2">
                            <span class="badge"
                                style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 16px;">
                                <i class="bi bi-circle-fill" style="font-size: 8px; animation: pulse 2s infinite;"></i>
                                Your Node: <code style="color: white;">{{ node.node_id|slice:":12" }}...</code>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-dawn mb-2" onclick="showShareModal()">
                            <i class="bi bi-share"></i> Share Knowledge
                        </button>
                        <button class="btn btn-outline-dawn mb-2" onclick="discoverNodes()">
                            <i class="bi bi-radar"></i> Discover Nodes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dawn-card">
                <h4 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-diagram-3-fill"></i> Network Topology
                </h4>
                <div id="network-graph"
                    style="height: 300px; background: #000; border-radius: 12px; position: relative; overflow: hidden;">
                    <!-- Network visualization will be drawn here -->
                    <canvas id="network-canvas"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small style="color: #666;">
                        <i class="bi bi-info-circle"></i>
                        Live P2P mesh network showing Black Box connections
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Stats -->
    <div class="row mb-4 g-4">
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 glow-text fw-bold">{{ total_nodes }}</div>
                <div style="color: #666; font-weight: 500;">Active Nodes</div>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i> Live on network
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: var(--dawn-purple);">{{ my_shared_knowledge }}</div>
                <div style="color: #666; font-weight: 500;">Shared by You</div>
                <small style="color: var(--dawn-purple);">
                    <i class="bi bi-box-seam"></i> In network
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: var(--dawn-blue);">{{ received_knowledge }}</div>
                <div style="color: #666; font-weight: 500;">Downloaded</div>
                <small style="color: var(--dawn-blue);">
                    <i class="bi bi-download"></i> Cached locally
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dawn-card text-center">
                <div class="h2 mb-2 fw-bold" style="color: #4CAF50;">{{ active_connections }}</div>
                <div style="color: #666; font-weight: 500;">P2P Links</div>
                <small class="text-success">
                    <i class="bi bi-link-45deg"></i> Encrypted
                </small>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Public Knowledge Network -->
        <div class="col-lg-8">
            <div class="dawn-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0 fw-bold" style="color: var(--dawn-dark);">
                        <i class="bi bi-globe2"></i> Decentralized Knowledge Pool
                    </h4>
                    <div>
                        <select class="form-select form-select-sm" id="category-filter" onchange="filterKnowledge()"
                            style="border-radius: 12px; border: 2px solid rgba(0,0,0,0.1);">
                            <option value="all">All Categories</option>
                            <option value="technology">Technology</option>
                            <option value="science">Science</option>
                            <option value="education">Education</option>
                            <option value="privacy">Privacy & Security</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                </div>

                <div class="knowledge-grid" id="knowledge-grid">
                    {% for knowledge in public_knowledge %}
                    <div class="knowledge-card p-3 mb-3" data-category="{{ knowledge.category }}" style="background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05)); 
                                border-radius: 16px; border-left: 4px solid var(--dawn-orange);
                                transition: all 0.3s ease;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div style="flex: 1;">
                                <h6 class="mb-1 fw-bold" style="color: var(--dawn-dark);">
                                    <i class="bi bi-file-earmark-lock"></i> {{ knowledge.title }}
                                </h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <span class="badge"
                                        style="background: var(--dawn-purple); color: white; font-size: 10px;">
                                        {{ knowledge.category }}
                                    </span>
                                    <span class="badge"
                                        style="background: rgba(0,0,0,0.1); color: #666; font-size: 10px;">
                                        üîê Encrypted
                                    </span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-1">
                                    <small class="badge" style="background: #4CAF50; color: white; font-size: 9px;">
                                        Rep: {{ knowledge.shared_by.reputation_score }}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <p class="mb-2 small" style="color: #666;">
                            <i class="bi bi-person-badge"></i> Node:
                            <code>{{ knowledge.shared_by.node_id|slice:":8" }}...</code>
                        </p>

                        <div class="d-flex justify-content-between align-items-center">
                            <small style="color: #999;">
                                <i class="bi bi-download"></i> {{ knowledge.downloads }} ‚Ä¢
                                <i class="bi bi-hand-thumbs-up"></i> {{ knowledge.upvotes }} ‚Ä¢
                                <i class="bi bi-clock"></i> {{ knowledge.created_at|timesince }} ago
                            </small>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-1"
                                    onclick="upvoteKnowledge({{ knowledge.id }})">
                                    <i class="bi bi-hand-thumbs-up"></i>
                                </button>
                                <button class="btn btn-sm btn-dawn" onclick="downloadKnowledge({{ knowledge.id }})">
                                    <i class="bi bi-download"></i> Get
                                </button>
                            </div>
                        </div>

                        <!-- Encryption indicator -->
                        <div class="mt-2 p-2" style="background: rgba(76,175,80,0.05); border-radius: 8px;">
                            <small style="color: #4CAF50; font-size: 10px;">
                                <i class="bi bi-shield-lock-fill"></i>
                                End-to-end encrypted transfer ‚Ä¢ Hash:
                                <code>{{ knowledge.encryption_key_hash|slice:":8" }}...</code>
                            </small>
                        </div>
                        <!-- Blockchain indicator (show if wallet connected) -->
                        <!-- Add after encryption indicator in knowledge card -->
                        {% if knowledge.blockchain_tx %}
                        <div class="mt-2 p-2" style="background: rgba(107,53,255,0.05); border-radius: 8px;">
                            <small style="color: var(--dawn-purple); font-size: 10px;">
                                <i class="bi bi-link-45deg"></i>
                                Recorded on Solana ‚Ä¢
                                <a href="https://explorer.solana.com/tx/{{ knowledge.blockchain_tx }}?cluster=devnet"
                                    target="_blank" style="color: var(--dawn-purple);">
                                    View TX
                                </a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.2; color: var(--dawn-dark);"></i>
                        <p class="mt-3 mb-3" style="color: #999;">No knowledge in the network yet</p>
                        <button class="btn btn-dawn" onclick="showShareModal()">
                            <i class="bi bi-plus-circle"></i> Be the first to share!
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Your Shared Knowledge -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-box-seam"></i> Your Contributions
                </h5>
                {% for knowledge in my_knowledge %}
                <div class="p-3 mb-2"
                    style="background: rgba(255,107,53,0.05); border-radius: 12px; border-left: 3px solid var(--dawn-orange);">
                    <div class="fw-bold small mb-1">{{ knowledge.title|truncatechars:30 }}</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small style="color: #999;">
                            <i class="bi bi-download"></i> {{ knowledge.downloads }} downloads
                        </small>
                        <span class="badge"
                            style="background: {{ knowledge.is_public|yesno:'#4CAF50,#ff9800' }}; color: white; font-size: 9px;">
                            {{ knowledge.is_public|yesno:'Public,Private' }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="bi bi-box" style="font-size: 32px; opacity: 0.2;"></i>
                    <p class="small mt-2 mb-0" style="color: #999;">No knowledge shared yet</p>
                </div>
                {% endfor %}
            </div>

            <!-- Connected Nodes -->
            <div class="dawn-card mb-4">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-diagram-3"></i> Mesh Network
                </h5>
                <div class="mb-3 p-2" style="background: rgba(76,175,80,0.05); border-radius: 8px;">
                    <small class="text-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Peer-to-Peer Mode:</strong> Direct connections
                    </small>
                </div>
                {% for connected_node in connected_nodes %}
                <div class="d-flex align-items-center mb-2 p-2"
                    style="background: rgba(0,0,0,0.02); border-radius: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,107,53,0.1)'"
                    onmouseout="this.style.background='rgba(0,0,0,0.02)'">
                    <div class="me-2">
                        <span class="badge bg-success"
                            style="width: 12px; height: 12px; border-radius: 50%; padding: 0; animation: pulse 2s infinite;"></span>
                    </div>
                    <div style="flex: 1;">
                        <div class="small fw-bold">
                            <i class="bi bi-hdd-network"></i> {{ connected_node.node_id|slice:":12" }}...
                        </div>
                        <small style="color: #999;">
                            Trust: {{ connected_node.reputation_score }}/100
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger"
                        onclick="connectToNode('{{ connected_node.node_id }}')"
                        style="font-size: 10px; padding: 4px 8px; border-radius: 8px;">
                        <i class="bi bi-link-45deg"></i>
                    </button>
                </div>
                {% empty %}
                <div class="text-center py-3">
                    <i class="bi bi-diagram-3" style="font-size: 32px; opacity: 0.2;"></i>
                    <p class="small mt-2 mb-2" style="color: #999;">No connections yet</p>
                    <button class="btn btn-sm btn-dawn" onclick="discoverNodes()">
                        <i class="bi bi-radar"></i> Discover
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- Network Stats -->
            <div class="dawn-card"
                style="background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05));">
                <h5 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-graph-up"></i> Network Health
                </h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small style="color: #666;">Node Reputation</small>
                        <small class="fw-bold" style="color: var(--dawn-orange);">
                            {{ node.reputation_score }}/100
                        </small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(0,0,0,0.1);">
                        <div class="progress-bar"
                            style="width: {{ node.reputation_score }}%; background: var(--dawn-orange);"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small style="color: #666;">Network Coverage</small>
                        <small class="fw-bold" style="color: #4CAF50;">
                            {{ active_connections }}/10
                        </small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(0,0,0,0.1);">
                        <div class="progress-bar bg-success"
                            style="width: {% if active_connections > 0 %}{{ active_connections }}0{% else %}5{% endif %}%;">
                        </div>
                    </div>
                </div>
                <div class="p-2" style="background: rgba(0,0,0,0.05); border-radius: 8px;">
                    <small style="color: #666;">
                        <i class="bi bi-shield-check"></i> All transfers encrypted with RSA-2048
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Knowledge Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header"
                style="border-bottom: 1px solid rgba(0,0,0,0.05); background: linear-gradient(135deg, rgba(255,107,53,0.05), rgba(107,53,255,0.05));">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-share"></i> Share Knowledge to P2P Network
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3"
                    style="border-radius: 12px; border-left: 4px solid var(--dawn-blue);">
                    <small>
                        <strong><i class="bi bi-info-circle"></i> How it works:</strong><br>
                        Your knowledge will be encrypted and broadcast to all connected Black Box nodes in the mesh
                        network.
                    </small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Title</label>
                    <input type="text" class="form-control" id="knowledge-title"
                        placeholder="e.g., Best practices for secure AI deployment" style="border-radius: 12px;">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Content</label>
                    <textarea class="form-control" id="knowledge-content" rows="6" placeholder="Share your knowledge..."
                        style="border-radius: 12px;"></textarea>
                    <small style="color: #666;">
                        <i class="bi bi-lock-fill"></i> Will be encrypted before transmission
                    </small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Category</label>
                    <select class="form-select" id="knowledge-category" style="border-radius: 12px;">
                        <option value="general">General</option>
                        <option value="technology">Technology</option>
                        <option value="science">Science</option>
                        <option value="education">Education</option>
                        <option value="privacy">Privacy & Security</option>
                    </select>
                </div>
                <div class="form-check p-3" style="background: rgba(76,175,80,0.05); border-radius: 12px;">
                    <input class="form-check-input" type="checkbox" id="knowledge-public" checked>
                    <label class="form-check-label fw-bold" for="knowledge-public">
                        <i class="bi bi-globe"></i> Broadcast to public P2P network
                    </label>
                    <br>
                    <small style="color: #666;">Uncheck for private sharing only</small>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0,0,0,0.05);">
                <button type="button" class="btn btn-outline-dawn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dawn" onclick="shareKnowledge()">
                    <i class="bi bi-broadcast"></i> Broadcast to Network
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Network Visualization
    const canvas = document.getElementById('network-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.parentElement.offsetWidth;
    canvas.height = 300;

    // Simple network visualization
    function drawNetwork() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw center node (you)
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        ctx.fillStyle = '#FF6B35';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = '#fff';
        ctx.font = '10px monospace';
        ctx.fillText('YOU', centerX - 15, centerY + 4);

        // Draw connected nodes - FIX THE TEMPLATE VARIABLE
        const nodeCount = parseInt('{{ total_nodes }}') || 1;  // Fixed!
        for (let i = 0; i < Math.min(nodeCount, 8); i++) {
            const angle = (i / 8) * 2 * Math.PI;
            const x = centerX + Math.cos(angle) * 120;
            const y = centerY + Math.sin(angle) * 100;

            // Draw connection line
            ctx.strokeStyle = 'rgba(76, 175, 80, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();

            // Draw node
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(x, y, 10, 0, 2 * Math.PI);
            ctx.fill();
        }
    }

    drawNetwork();

    // Redraw on window resize
    window.addEventListener('resize', () => {
        canvas.width = canvas.parentElement.offsetWidth;
        drawNetwork();
    });

    function showShareModal() {
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    }

    async function shareKnowledge() {
        const title = document.getElementById('knowledge-title').value;
        const content = document.getElementById('knowledge-content').value;
        const category = document.getElementById('knowledge-category').value;
        const isPublic = document.getElementById('knowledge-public').checked;

        if (!title || !content) {
            showNotification('‚ö†Ô∏è Please fill in all fields', 'warning');
            return;
        }

        showNotification('üîê Encrypting content...', 'success');

        try {
            // Step 1: Create knowledge entry
            const response = await fetch('/p2p/share/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    category: category,
                    is_public: isPublic
                })
            });

            const data = await response.json();

            if (data.success) {
                // Step 2: If requires blockchain signature
                if (data.requires_signature && window.solana && window.solana.isConnected) {
                    showNotification('‚úçÔ∏è Please sign the transaction in your wallet...', 'success');

                    try {
                        // Sign message with wallet
                        const message = new TextEncoder().encode(data.message_to_sign);
                        const signedMessage = await window.solana.signMessage(message, 'utf8');
                        const signature = btoa(String.fromCharCode(...signedMessage.signature));

                        showNotification('üìù Signature received, recording on blockchain...', 'success');

                        // Step 3: Confirm on blockchain
                        const confirmResponse = await fetch('/p2p/confirm-blockchain/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                knowledge_id: data.knowledge_id,
                                signature: signature,
                                transaction_data: data.transaction_data
                            })
                        });

                        const confirmData = await confirmResponse.json();

                        if (confirmData.success) {
                            showNotification(`‚úÖ Knowledge recorded on Solana! TX: ${confirmData.tx_signature.slice(0, 8)}...`, 'success');

                            // Show blockchain confirmation modal
                            showBlockchainConfirmation(confirmData);
                        } else {
                            showNotification('‚ö†Ô∏è Blockchain confirmation failed, but knowledge saved locally', 'warning');
                        }
                    } catch (signError) {
                        console.error('Signing error:', signError);
                        showNotification('‚ö†Ô∏è Transaction cancelled, but knowledge saved locally', 'warning');
                    }
                } else {
                    showNotification('‚úÖ Knowledge shared successfully!', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Network error: ' + error.message, 'error');
        }
    }

    function showBlockchainConfirmation(data) {
        const modal = document.createElement('div');
        modal.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 20px; border: 2px solid var(--dawn-purple);">
                    <div class="modal-header" style="background: linear-gradient(135deg, rgba(107,53,255,0.1), rgba(255,107,53,0.05)); border-bottom: 2px solid var(--dawn-purple);">
                        <h5 class="modal-title fw-bold">
                            <i class="bi bi-check-circle-fill text-success"></i> Blockchain Confirmed!
                        </h5>
                        <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body text-center p-4">
                        <div class="mb-4" style="font-size: 64px;">‚õìÔ∏è</div>
                        <h5 class="fw-bold mb-3" style="color: var(--dawn-dark);">Knowledge Recorded on Solana</h5>
                        <p class="text-muted mb-4">Your knowledge has been permanently recorded on the Solana blockchain</p>
                        
                        <div class="p-3 mb-3" style="background: rgba(107,53,255,0.05); border-radius: 12px;">
                            <small class="text-muted d-block mb-1">Transaction Signature:</small>
                            <code style="font-size: 0.85rem; word-break: break-all; color: var(--dawn-purple);">
                                ${data.tx_signature}
                            </code>
                        </div>
                        
                        <a href="${data.explorer_url}" target="_blank" class="btn btn-dawn w-100">
                            <i class="bi bi-box-arrow-up-right me-2"></i>View on Solana Explorer
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);

        // Auto-remove after 10 seconds
        setTimeout(() => modal.remove(), 10000);
    }

    async function downloadKnowledge(knowledgeId) {
        showNotification('üîê Establishing encrypted P2P connection...', 'success');

        try {
            const response = await fetch(`/p2p/download/${knowledgeId}/`);
            const data = await response.json();

            if (data.success) {
                showNotification('‚úÖ Knowledge downloaded via encrypted P2P transfer!', 'success');

                // Display downloaded content
                const modal = document.createElement('div');
                modal.innerHTML = `
                <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.7);">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(107,53,255,0.1));">
                                <h5 class="modal-title fw-bold">
                                    <i class="bi bi-file-earmark-lock"></i> ${escapeHtml(data.title)}
                                </h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <span class="badge" style="background: var(--dawn-purple);">${data.category}</span>
                                    <span class="badge bg-secondary">From: ${data.shared_by}</span>
                                    <span class="badge" style="background: #4CAF50;">
                                        <i class="bi bi-shield-check"></i> Decrypted
                                    </span>
                                </div>
                                <div style="white-space: pre-wrap; padding: 20px; background: #F5F5F5; border-radius: 12px; max-height: 400px; overflow-y: auto;">${escapeHtml(data.content)}</div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-dawn" onclick="copyToClipboard(\`${escapeHtml(data.content).replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                    <i class="bi bi-clipboard"></i> Copy Content
                                </button>
                                <button class="btn btn-outline-dawn" onclick="this.closest('.modal').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Network error: ' + error.message, 'error');
        }
    }

    async function upvoteKnowledge(knowledgeId) {
        try {
            const response = await fetch(`/p2p/upvote/${knowledgeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification('üëç Upvoted! Reputation increased.', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Error: ' + error.message, 'error');
        }
    }

    function discoverNodes() {
        showNotification('üîç Scanning P2P network for Black Box nodes...', 'success');

        // Simulate network discovery
        setTimeout(() => {
            const totalNodes = parseInt('{{ total_nodes }}') || 1;  // Fixed!
            showNotification('‚úÖ Found ' + totalNodes + ' active nodes in mesh network!', 'success');
            setTimeout(() => location.reload(), 1500);
        }, 2000);
    }

    async function connectToNode(nodeId) {
        showNotification('ü§ù Establishing encrypted P2P connection...', 'success');

        try {
            const response = await fetch(`/p2p/connect/${nodeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification('‚úÖ ' + data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('‚ùå Error: ' + error.message, 'error');
        }
    }

    function filterKnowledge() {
        const filter = document.getElementById('category-filter').value;
        const cards = document.querySelectorAll('.knowledge-card');

        cards.forEach(card => {
            if (filter === 'all' || card.dataset.category === filter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function copyToClipboard(text) {
        // Remove HTML entities and clean text
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        const cleanText = tempDiv.textContent || tempDiv.innerText || '';

        navigator.clipboard.writeText(cleanText).then(() => {
            showNotification('üìã Copied to clipboard!', 'success');
        }).catch(err => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = cleanText;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('üìã Copied to clipboard!', 'success');
            } catch (err) {
                showNotification('‚ùå Failed to copy', 'error');
            }
            document.body.removeChild(textArea);
        });
    }

    function showNotification(message, type = 'success') {
        const colors = {
            success: '#4CAF50',
            error: '#f44336',
            warning: '#ff9800'
        };

        const notification = document.createElement('div');
        notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3';
        notification.style.cssText = `background: ${colors[type]}; color: white; border-radius: 16px; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2); animation: slideIn 0.3s;`;
        notification.innerHTML = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Animate network connections periodically
    setInterval(() => {
        const connections = document.querySelectorAll('.badge.bg-success');
        connections.forEach(conn => {
            conn.style.animation = 'none';
            setTimeout(() => {
                conn.style.animation = 'pulse 2s infinite';
            }, 10);
        });
    }, 5000);
</script>

<style>
    .knowledge-card {
        transition: all 0.3s ease;
    }

    .knowledge-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-left-width: 6px !important;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    #network-canvas {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}