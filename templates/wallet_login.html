{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="dawn-card p-5">
                <div class="text-center mb-4">
                    <div class="dawn-logo mx-auto mb-3" style="width: 80px; height: 80px; font-size: 40px;">‚òÄÔ∏è</div>
                    <h2 class="fw-bold mb-2" style="color: var(--dawn-dark);">Welcome to DawnGuard</h2>
                    <p style="color: #666;">Connect your Solana wallet to continue</p>
                </div>

                <!-- Wallet Connection Card -->
                <div id="wallet-connect-section">
                    <div class="alert alert-info mb-4" style="border-radius: 12px; border-left: 4px solid var(--dawn-blue);">
                        <small>
                            <strong><i class="bi bi-info-circle"></i> True Web3 Authentication</strong><br>
                            No passwords. No emails. Just your wallet signature.
                        </small>
                    </div>

                    <button class="btn btn-dawn w-100 py-3 mb-3" onclick="connectAndLogin()" id="connect-btn">
                        <i class="bi bi-wallet2 me-2"></i> Connect Phantom Wallet
                    </button>

                    <div class="text-center">
                        <small style="color: #999;">
                            Don't have Phantom? 
                            <a href="https://phantom.app/" target="_blank" style="color: var(--dawn-orange);">Get it here</a>
                        </small>
                    </div>
                </div>

                <!-- Signing Step -->
                <div id="wallet-signing-section" style="display: none;">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="fw-bold mb-2">Sign the Message</h5>
                        <p style="color: #666;">Check your wallet for the signing request</p>
                    </div>

                    <div class="p-3 mb-3" style="background: rgba(0,0,0,0.02); border-radius: 12px;">
                        <small style="color: #666; font-family: monospace; word-break: break-all;" id="sign-message"></small>
                    </div>
                </div>

                <!-- Traditional Login Link -->
                <hr class="my-4">
                
                <div class="text-center">
                    <small style="color: #999;">
                        Or use 
                        <a href="{% url 'login' %}" style="color: var(--dawn-orange); text-decoration: none;">
                            traditional login
                        </a>
                    </small>
                </div>

                <div class="mt-4 p-3" style="background: rgba(76,175,80,0.05); border-radius: 12px; border: 1px solid rgba(76,175,80,0.2);">
                    <small class="text-success d-block mb-1">
                        <i class="bi bi-shield-check"></i> Decentralized authentication
                    </small>
                    <small class="text-success d-block mb-1">
                        <i class="bi bi-key"></i> No passwords to remember
                    </small>
                    <small class="text-success d-block">
                        <i class="bi bi-incognito"></i> True Web3 dApp
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Wallet authentication script - SINGLE INSTANCE ONLY
(function() {
    'use strict';
    
    let walletAddress = null;
    let isConnecting = false;

    window.connectAndLogin = async function() {
        if (isConnecting) {
            console.log('Already connecting, please wait...');
            return;
        }

        try {
            isConnecting = true;
            
            // Check if Phantom is installed
            const { solana } = window;
            
            if (!solana) {
                showNotification('‚ùå Phantom wallet not detected!', 'error');
                setTimeout(() => {
                    window.open('https://phantom.app/', '_blank');
                }, 2000);
                isConnecting = false;
                return;
            }

            if (!solana.isPhantom) {
                showNotification('‚ùå Please install Phantom wallet extension!', 'error');
                setTimeout(() => {
                    window.open('https://phantom.app/', '_blank');
                }, 2000);
                isConnecting = false;
                return;
            }

            // Step 1: Connect wallet
            console.log('Step 1: Connecting to Phantom...');
            showNotification('üîó Connecting to Phantom...', 'success');
            
            const response = await solana.connect({ onlyIfTrusted: false });
            walletAddress = response.publicKey.toString();
            
            console.log('Connected wallet:', walletAddress);
            showNotification(`‚úÖ Connected: ${walletAddress.slice(0,4)}...${walletAddress.slice(-4)}`, 'success');
            
            // Step 2: Get challenge from server
            console.log('Step 2: Requesting challenge from server...');
            const challengeResponse = await fetch('/wallet/auth/challenge/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ wallet: walletAddress }),
                credentials: 'include'  // Important for sessions
            });
            
            if (!challengeResponse.ok) {
                throw new Error(`Server error: ${challengeResponse.status}`);
            }
            
            const challengeData = await challengeResponse.json();
            console.log('Challenge received:', challengeData.success);
            
            if (!challengeData.success) {
                throw new Error(challengeData.error || 'Failed to get challenge');
            }
            
            // Show signing section
            document.getElementById('wallet-connect-section').style.display = 'none';
            document.getElementById('wallet-signing-section').style.display = 'block';
            document.getElementById('sign-message').textContent = challengeData.challenge;
            
            // Step 3: Sign message
            console.log('Step 3: Requesting signature from wallet...');
            showNotification('‚úçÔ∏è Please sign the message in your wallet', 'success');
            
            const encodedMessage = new TextEncoder().encode(challengeData.challenge);
            const signedMessage = await solana.signMessage(encodedMessage, 'utf8');
            
            // Convert signature to base64
            const signature = btoa(String.fromCharCode.apply(null, signedMessage.signature));
            console.log('Signature obtained, length:', signature.length);
            
            // Step 4: Verify signature and login
            console.log('Step 4: Verifying signature with server...');
            showNotification('üîê Verifying signature...', 'success');
            
            const verifyResponse = await fetch('/wallet/auth/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    wallet: walletAddress,
                    signature: signature
                }),
                credentials: 'include'  // Important for sessions
            });
            
            if (!verifyResponse.ok) {
                const errorText = await verifyResponse.text();
                console.error('Verification failed:', errorText);
                throw new Error(`Verification failed: ${verifyResponse.status}`);
            }
            
            const verifyData = await verifyResponse.json();
            console.log('Verification response:', verifyData);
            
            if (verifyData.success) {
                showNotification('‚úÖ Authentication successful! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = verifyData.redirect || '/dashboard/';
                }, 1500);
            } else {
                throw new Error(verifyData.error || 'Authentication failed');
            }
            
        } catch (error) {
            console.error('Wallet login error:', error);
            
            let errorMessage = 'Connection failed';
            if (error.message) {
                errorMessage = error.message;
            } else if (error.code === 4001) {
                errorMessage = 'You rejected the connection';
            } else if (error.code === -32603) {
                errorMessage = 'Internal wallet error';
            }
            
            showNotification(`‚ùå ${errorMessage}`, 'error');
            
            // Reset UI
            document.getElementById('wallet-connect-section').style.display = 'block';
            document.getElementById('wallet-signing-section').style.display = 'none';
        } finally {
            isConnecting = false;
        }
    };

    function showNotification(message, type = 'success') {
        const colors = {
            success: '#4CAF50',
            error: '#f44336',
            warning: '#ff9800'
        };

        // Remove any existing notifications
        const existing = document.querySelectorAll('.wallet-notification');
        existing.forEach(el => el.remove());

        const notification = document.createElement('div');
        notification.className = 'wallet-notification position-fixed top-0 end-0 m-4 p-3 rounded-3';
        notification.style.cssText = `
            background: ${colors[type]}; 
            color: white; 
            border-radius: 12px; 
            z-index: 9999; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
            max-width: 350px;
        `;
        notification.innerHTML = `<strong>${message}</strong>`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-detect connected wallet on page load
    window.addEventListener('load', async () => {
        try {
            const { solana } = window;
            if (solana && solana.isPhantom) {
                console.log('‚úÖ Phantom wallet detected');
                
                // Check if already connected
                if (solana.isConnected) {
                    const publicKey = solana.publicKey;
                    if (publicKey) {
                        const address = publicKey.toString();
                        document.getElementById('connect-btn').innerHTML = 
                            `<i class="bi bi-wallet2 me-2"></i> Continue as ${address.slice(0,4)}...${address.slice(-4)}`;
                    }
                }
            } else {
                console.log('‚ö†Ô∏è Phantom wallet not detected');
            }
        } catch (error) {
            console.error('Error detecting wallet:', error);
        }
    });
})();
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}