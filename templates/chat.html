<!-- templates/chat.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: var(--dawn-cream);">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="dawn-card p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold" style="color: var(--dawn-dark);">
                        <i class="bi bi-chat-dots"></i> Your Chats
                    </h6>
                    <span class="badge" style="background: var(--dawn-orange); color: white;">{{ conversations.count }}</span>
                </div>
                
                <div class="list-group list-group-flush" style="max-height: 50vh; overflow-y: auto;">
                    {% for conv in conversations %}
                    <a href="{% url 'chat_with_id' conv.id %}" 
                       class="list-group-item bg-transparent border-0 {% if conv.id == conversation.id %}active-chat{% endif %}"
                       style="border-left: 3px solid {% if conv.id == conversation.id %}var(--dawn-orange){% else %}transparent{% endif %} !important; padding-left: 12px; color: var(--dawn-dark); border-radius: 8px; margin-bottom: 4px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div class="fw-bold">{{ conv.title|truncatechars:20 }}</div>
                                <small style="color: #999;">{{ conv.get_message_count }} messages</small>
                            </div>
                            <small style="color: #999;">{{ conv.updated_at|date:"M d" }}</small>
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center py-3" style="color: #999;">
                        <p>No conversations yet</p>
                    </div>
                    {% endfor %}
                </div>
                
                <a href="{% url 'chat' %}" class="btn btn-dawn w-100 mt-3">
                    <i class="bi bi-plus-circle"></i> New Chat
                </a>
            </div>
            
            <!-- Privacy Status -->
            <div class="dawn-card p-3">
                <h6 class="mb-3 fw-bold" style="color: var(--dawn-dark);">
                    <i class="bi bi-shield-check"></i> Security Status
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <small style="color: #666;">End-to-End Encryption</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <small style="color: #666;">Local Processing Only</small>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <small style="color: #666;">Zero Data Collection</small>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9">
            <div class="dawn-card" style="height: 80vh; display: flex; flex-direction: column;">
                <!-- Chat Header -->
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                    <div>
                        <h5 class="mb-1 fw-bold" style="color: var(--dawn-dark);">{{ conversation.title }}</h5>
                        <small style="color: #999;">
                            <i class="bi bi-lock-fill"></i> Encrypted ‚Ä¢ 
                            <i class="bi bi-cpu"></i> Local AI ‚Ä¢ 
                            <span id="status-indicator" class="text-success">Ready</span>
                        </small>
                    </div>
                    <div>
                        <a href="{% url 'delete_conversation' conversation.id %}" 
                           class="btn btn-sm btn-outline-danger"
                           style="border-radius: 12px;"
                           onclick="return confirm('Are you sure you want to delete this conversation?')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3" style="scroll-behavior: smooth;">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message-wrapper mb-3">
                            <div class="d-flex {% if message.role == 'user' %}justify-content-end{% endif %}">
                                <div class="message-bubble p-3 rounded-3" 
                                     style="max-width: 75%; {% if message.role == 'user' %}background: var(--dawn-orange); color: white;{% else %}background: #F5F5F5; color: var(--dawn-dark);{% endif %} border-radius: 20px;">
                                    
                                    <div class="mb-2">
                                        <span class="badge" style="background: rgba(0,0,0,0.1); font-size: 10px; font-weight: 600;">
                                            {% if message.role == 'user' %}üë§ You{% else %}ü§ñ AI{% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="message-content">{{ message.content }}</div>
                                    
                                    <div class="text-end mt-2">
                                        <small style="opacity: 0.7; font-size: 11px;">
                                            {{ message.timestamp|date:"H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center mt-5" style="color: #999;">
                            <i class="bi bi-chat-dots" style="font-size: 48px; opacity: 0.3;"></i>
                            <p class="mt-3">Start a conversation with your private AI assistant</p>
                            <p class="small">Everything stays encrypted and local on your device</p>
                        </div>
                    {% endif %}
                    
                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="message-wrapper mb-3" style="display: none;">
                        <div class="d-flex">
                            <div class="message-bubble p-3 rounded-3" style="background: #F5F5F5; border-radius: 20px;">
                                <div class="typing-animation">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div style="background: #F5F5F5; border-radius: 16px; padding: 12px;">
                    <div class="d-flex gap-2">
                        <textarea 
                            id="message-input" 
                            class="form-control border-0" 
                            placeholder="Ask anything... Your data never leaves this device üîí"
                            rows="2"
                            style="resize: none; box-shadow: none; background: white; border-radius: 12px; color: var(--dawn-dark);"
                        ></textarea>
                        <button class="btn btn-dawn align-self-end" onclick="sendMessage()" id="send-btn" style="border-radius: 12px; padding: 12px 24px;">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.typing-animation span {
    width: 8px;
    height: 8px;
    background: var(--dawn-orange);
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
}

.typing-animation span:nth-child(1) { animation-delay: -0.32s; }
.typing-animation span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.active-chat {
    background: rgba(255, 107, 53, 0.05) !important;
}

.active-chat:hover {
    background: rgba(255, 107, 53, 0.1) !important;
}
</style>

<script>
// Keep all your existing JavaScript - just update color references
const conversationId = {{ conversation.id }};

function addMessageToUI(message, role) {
    const messagesDiv = document.getElementById('chat-messages');
    const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    const bgColor = role === 'user' ? 'var(--dawn-orange)' : '#F5F5F5';
    const textColor = role === 'user' ? 'white' : 'var(--dawn-dark)';
    
    const messageHtml = `
        <div class="message-wrapper mb-3">
            <div class="d-flex ${role === 'user' ? 'justify-content-end' : ''}">
                <div class="message-bubble p-3 rounded-3" 
                     style="max-width: 75%; background: ${bgColor}; color: ${textColor}; border-radius: 20px;">
                    
                    <div class="mb-2">
                        <span class="badge" style="background: rgba(0,0,0,0.1); font-size: 10px; font-weight: 600;">
                            ${role === 'user' ? 'üë§ You' : 'ü§ñ AI'}
                        </span>
                    </div>
                    
                    <div class="message-content">${escapeHtml(message)}</div>
                    
                    <div class="text-end mt-2">
                        <small style="opacity: 0.7; font-size: 11px;">
                            ${timestamp}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    const sendBtn = document.getElementById('send-btn');
    
    if (!message) return;
    
    input.disabled = true;
    sendBtn.disabled = true;
    
    addMessageToUI(message, 'user');
    input.value = '';
    
    document.getElementById('typing-indicator').style.display = 'block';
    document.getElementById('status-indicator').textContent = 'Processing...';
    document.getElementById('status-indicator').className = 'text-warning';
    
    fetch(`/chat/${conversationId}/send/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('typing-indicator').style.display = 'none';
        
        if (data.success) {
            addMessageToUI(data.response, 'assistant');
            showEncryptionNotification();
        } else {
            showError(data.error || 'Failed to send message');
        }
    })
    .catch(error => {
        document.getElementById('typing-indicator').style.display = 'none';
        showError('Network error. Please try again.');
        console.error('Error:', error);
    })
    .finally(() => {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
        document.getElementById('status-indicator').textContent = 'Ready';
        document.getElementById('status-indicator').className = 'text-success';
    });
}

function showEncryptionNotification() {
    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3';
    notification.style.cssText = 'background: rgba(76, 175, 80, 0.95); color: white; border-radius: 16px; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.1);';
    notification.innerHTML = 'üîê <strong>Message Encrypted</strong><br><small>Stored securely on your device</small>';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 2500);
}

function showError(message) {
    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3';
    notification.style.cssText = 'background: #f44336; color: white; z-index: 9999; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);';
    notification.innerHTML = `‚ùå <strong>Error:</strong> ${message}`;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

window.addEventListener('load', () => {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
{% endblock %}