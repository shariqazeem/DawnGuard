<!-- templates/chat.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar with Conversations -->
        <div class="col-md-3">
            <div class="cyber-card p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-uppercase mb-0" style="color: var(--primary-accent);">
                        <i class="bi bi-chat-dots"></i> Chats
                    </h6>
                    <span class="badge bg-success">{{ conversations.count }}</span>
                </div>
                
                <div class="list-group list-group-flush" style="max-height: 50vh; overflow-y: auto;">
                    {% for conv in conversations %}
                    <a href="{% url 'chat_with_id' conv.id %}" 
                       class="list-group-item bg-transparent text-white border-0 {% if conv.id == conversation.id %}active{% endif %}"
                       style="border-left: 3px solid {% if conv.id == conversation.id %}var(--primary-accent){% else %}transparent{% endif %} !important; padding-left: 12px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div class="fw-bold">{{ conv.title|truncatechars:20 }}</div>
                                <small class="text-secondary">{{ conv.get_message_count }} messages</small>
                            </div>
                            <small class="text-secondary">{{ conv.updated_at|date:"M d" }}</small>
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center text-secondary py-3">
                        <p>No conversations yet</p>
                    </div>
                    {% endfor %}
                </div>
                
                <a href="{% url 'chat' %}" class="btn btn-cyber w-100 mt-3">
                    <i class="bi bi-plus-circle"></i> New Chat
                </a>
            </div>
            
            <!-- Privacy Status -->
            <div class="cyber-card p-3">
                <h6 class="text-uppercase mb-3" style="color: var(--primary-accent);">
                    <i class="bi bi-shield-check"></i> Security Status
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-success me-2">‚óè</span>
                    <small>End-to-End Encryption</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-success me-2">‚óè</span>
                    <small>Local Processing Only</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">‚óè</span>
                    <small>Zero Data Collection</small>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9">
            <div class="cyber-card p-4" style="height: 80vh; display: flex; flex-direction: column;">
                <!-- Chat Header -->
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
                    <div>
                        <h5 class="mb-1">{{ conversation.title }}</h5>
                        <small class="text-secondary">
                            <i class="bi bi-lock-fill"></i> Encrypted ‚Ä¢ 
                            <i class="bi bi-cpu"></i> Local AI ‚Ä¢ 
                            <span id="status-indicator" class="text-success">Ready</span>
                        </small>
                    </div>
                    <div>
                        <a href="{% url 'delete_conversation' conversation.id %}" 
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('Are you sure you want to delete this conversation?')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3" style="scroll-behavior: smooth;">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message-wrapper mb-3 animate__animated animate__fadeIn">
                            <div class="d-flex {% if message.role == 'user' %}justify-content-end{% endif %}">
                                <div class="message-bubble p-3 rounded-3 position-relative" 
                                     style="max-width: 75%; {% if message.role == 'user' %}background: linear-gradient(135deg, var(--primary-accent) 0%, #00b8d4 100%); color: #000;{% else %}background: var(--secondary); border: 1px solid rgba(0, 212, 255, 0.2);{% endif %}">
                                    
                                    <!-- Role Badge -->
                                    <div class="mb-2">
                                        <span class="badge" style="background: rgba(0,0,0,0.2); font-size: 10px;">
                                            {% if message.role == 'user' %}üë§ You{% else %}ü§ñ AI{% endif %}
                                        </span>
                                    </div>
                                    
                                    <!-- Message Content -->
                                    <div class="message-content">{{ message.content }}</div>
                                    
                                    <!-- Timestamp -->
                                    <div class="text-end mt-2">
                                        <small class="opacity-75" style="font-size: 11px;">
                                            {{ message.timestamp|date:"H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-secondary mt-5">
                            <i class="bi bi-chat-dots" style="font-size: 48px; opacity: 0.3;"></i>
                            <p class="mt-3">Start a conversation with your private AI assistant</p>
                            <p class="small">Everything stays encrypted and local on your device</p>
                        </div>
                    {% endif %}
                    
                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="message-wrapper mb-3" style="display: none;">
                        <div class="d-flex">
                            <div class="message-bubble p-3 rounded-3" style="background: var(--secondary);">
                                <div class="typing-animation">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="input-group" style="background: rgba(26, 31, 58, 0.5); border-radius: 12px; padding: 8px;">
                    <textarea 
                        id="message-input" 
                        class="form-control bg-transparent text-white border-0" 
                        placeholder="Ask anything... Your data never leaves this device üîí"
                        rows="2"
                        style="resize: none; box-shadow: none;"
                    ></textarea>
                    <button class="btn btn-cyber align-self-end" onclick="sendMessage()" id="send-btn">
                        <i class="bi bi-send-fill"></i> Send
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertPrompt('Summarize this for me:')">
                        üìù Summarize
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertPrompt('Explain this like I\'m 5:')">
                        üéì ELI5
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertPrompt('Help me write:')">
                        ‚úçÔ∏è Write
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-bubble {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.typing-animation {
    display: flex;
    gap: 4px;
}

.typing-animation span {
    width: 8px;
    height: 8px;
    background: var(--primary-accent);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
}

.typing-animation span:nth-child(1) { animation-delay: -0.32s; }
.typing-animation span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.list-group-item.active {
    background: rgba(0, 212, 255, 0.1) !important;
    color: var(--primary-accent) !important;
}

#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: var(--primary-accent);
    border-radius: 4px;
}
</style>

<script>
const conversationId = {{ conversation.id }};

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    const sendBtn = document.getElementById('send-btn');
    
    if (!message) return;
    
    // Disable input
    input.disabled = true;
    sendBtn.disabled = true;
    
    // Add user message to UI
    addMessageToUI(message, 'user');
    input.value = '';
    
    // Show typing indicator
    document.getElementById('typing-indicator').style.display = 'block';
    document.getElementById('status-indicator').textContent = 'Processing...';
    document.getElementById('status-indicator').className = 'text-warning';
    
    // Send to backend
    fetch(`/chat/${conversationId}/send/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        // Hide typing indicator
        document.getElementById('typing-indicator').style.display = 'none';
        
        if (data.success) {
            addMessageToUI(data.response, 'assistant');
            showEncryptionNotification();
        } else {
            showError(data.error || 'Failed to send message');
        }
    })
    .catch(error => {
        document.getElementById('typing-indicator').style.display = 'none';
        showError('Network error. Please try again.');
        console.error('Error:', error);
    })
    .finally(() => {
        // Re-enable input
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
        document.getElementById('status-indicator').textContent = 'Ready';
        document.getElementById('status-indicator').className = 'text-success';
    });
}

function addMessageToUI(message, role) {
    const messagesDiv = document.getElementById('chat-messages');
    const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    const messageHtml = `
        <div class="message-wrapper mb-3 animate__animated animate__fadeIn">
            <div class="d-flex ${role === 'user' ? 'justify-content-end' : ''}">
                <div class="message-bubble p-3 rounded-3 position-relative" 
                     style="max-width: 75%; ${role === 'user' 
                        ? 'background: linear-gradient(135deg, var(--primary-accent) 0%, #00b8d4 100%); color: #000;' 
                        : 'background: var(--secondary); border: 1px solid rgba(0, 212, 255, 0.2);'}">
                    
                    <div class="mb-2">
                        <span class="badge" style="background: rgba(0,0,0,0.2); font-size: 10px;">
                            ${role === 'user' ? 'üë§ You' : 'ü§ñ AI'}
                        </span>
                    </div>
                    
                    <div class="message-content">${escapeHtml(message)}</div>
                    
                    <div class="text-end mt-2">
                        <small class="opacity-75" style="font-size: 11px;">
                            ${timestamp}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showEncryptionNotification() {
    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3 animate__animated animate__fadeInUp';
    notification.style.cssText = 'background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); z-index: 9999;';
    notification.innerHTML = 'üîê <strong>Message Encrypted</strong><br><small>Stored securely on your device</small>';
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.classList.add('animate__fadeOutDown');
        setTimeout(() => notification.remove(), 500);
    }, 2500);
}

function showError(message) {
    const notification = document.createElement('div');
    notification.className = 'position-fixed bottom-0 end-0 m-4 p-3 rounded-3 bg-danger text-white';
    notification.style.zIndex = '9999';
    notification.innerHTML = `‚ùå <strong>Error:</strong> ${message}`;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function insertPrompt(prompt) {
    const input = document.getElementById('message-input');
    input.value = prompt + ' ';
    input.focus();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enter key support (Shift+Enter for new line)
document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-scroll to bottom on load
window.addEventListener('load', () => {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
