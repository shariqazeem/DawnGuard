{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #E8F4FF, #f0e6ff, #FFE5DC); min-height: 100vh;">
    <!-- Hero Header with Floating Animation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="kids-hero-card" style="background: linear-gradient(135deg, rgba(107,53,255,0.15), rgba(255,107,53,0.1)); border: 2px solid rgba(107,53,255,0.2); position: relative; overflow: hidden;">
                <!-- Animated Background Elements -->
                <div class="floating-emoji" style="position: absolute; top: 20px; right: 20px; font-size: 40px; animation: float 3s ease-in-out infinite;">üöÄ</div>
                <div class="floating-emoji" style="position: absolute; bottom: 30px; left: 30px; font-size: 35px; animation: float 4s ease-in-out infinite 0.5s;">‚ú®</div>
                <div class="floating-emoji" style="position: absolute; top: 50%; right: 100px; font-size: 30px; animation: float 3.5s ease-in-out infinite 1s;">üåü</div>

                <div class="row align-items-center position-relative" style="z-index: 1;">
                    <div class="col-md-8">
                        <h2 class="mb-3 fw-bold animate-slide-in" style="color: var(--dawn-dark); font-size: 2.5rem;">
                            <span class="robot-icon" style="display: inline-block; animation: bounce 2s infinite;">ü§ñ</span>
                            Kids-Safe AI Tutor
                        </h2>
                        <p class="mb-0 animate-fade-in" style="color: #555; font-size: 1.2rem; font-weight: 500; animation-delay: 0.2s;">
                            üéì Homework Help ‚Ä¢ üìö Learning Support ‚Ä¢ üîí 100% Safe & Monitored
                        </p>
                        <div class="mt-4 d-flex flex-wrap gap-2 animate-fade-in" style="animation-delay: 0.4s;">
                            <span class="safety-badge badge-bounce" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; padding: 10px 18px; font-size: 14px; border-radius: 25px; box-shadow: 0 4px 15px rgba(76,175,80,0.3); animation: badge-bounce 2s ease-in-out infinite;">
                                <i class="bi bi-shield-check-fill"></i> Content Filtered
                            </span>
                            <span class="safety-badge" style="background: linear-gradient(135deg, var(--dawn-purple), #8b5aff); color: white; padding: 10px 18px; font-size: 14px; border-radius: 25px; box-shadow: 0 4px 15px rgba(107,53,255,0.3); animation: badge-bounce 2s ease-in-out infinite 0.3s;">
                                <i class="bi bi-eye-fill"></i> Parent Monitored
                            </span>
                            <span class="safety-badge" style="background: linear-gradient(135deg, var(--dawn-orange), #ff8c5a); color: white; padding: 10px 18px; font-size: 14px; border-radius: 25px; box-shadow: 0 4px 15px rgba(255,107,53,0.3); animation: badge-bounce 2s ease-in-out infinite 0.6s;">
                                <i class="bi bi-cpu-fill"></i> Runs on Black Box
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-dawn btn-lg pulse-button" style="font-size: 1.1rem; padding: 16px 32px; box-shadow: 0 6px 20px rgba(255,107,53,0.4);">
                            <i class="bi bi-chat-dots-fill"></i> Start Learning!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface with Enhanced Design -->
    <div class="row">
        <div class="col-lg-8">
            <div class="chat-card" style="background: white; border-radius: 30px; min-height: 600px; box-shadow: 0 10px 40px rgba(107,53,255,0.15); border: 2px solid rgba(107,53,255,0.1);">
                <div id="chat-messages" class="mb-4" style="height: 500px; overflow-y: auto; padding: 24px; background: linear-gradient(180deg, #f8f9ff 0%, #fff 100%); border-radius: 28px 28px 0 0;">
                    {% if not llm_available %}
                    <div class="text-center py-5 animate-fade-in">
                        <div class="robot-container" style="font-size: 80px; animation: wiggle 3s ease-in-out infinite;">ü§ñ</div>
                        <h5 class="mt-4 fw-bold" style="color: #666; font-size: 1.5rem;">AI Tutor is in Demo Mode</h5>
                        <p class="text-muted" style="font-size: 1.1rem;">Ollama is not running. Install it to use real AI!</p>
                        <div class="demo-badge mt-3" style="background: linear-gradient(135deg, #FFC107, #FFD54F); color: #333; padding: 12px 24px; border-radius: 30px; display: inline-block; font-weight: 600; box-shadow: 0 4px 15px rgba(255,193,7,0.3);">
                            <i class="bi bi-lightbulb-fill"></i> Using Smart Demo Responses
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 animate-fade-in">
                        <div class="welcome-icon" style="font-size: 80px; animation: bounce-slow 3s ease-in-out infinite;">üí¨</div>
                        <h5 class="mt-4 fw-bold" style="color: var(--dawn-purple); font-size: 1.8rem;">Hi {{ family_member.display_name }}! üëã</h5>
                        <p class="text-muted" style="font-size: 1.1rem;">I'm your friendly AI tutor. Ask me anything about homework!</p>
                        <div class="d-flex gap-3 justify-content-center flex-wrap mt-4">
                            <button class="btn quick-start-btn" onclick="askSample('Help me with math homework')" style="background: linear-gradient(135deg, #FF6B35, #ff8c5a); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(255,107,53,0.3); transition: all 0.3s ease;">
                                üìê Math Help
                            </button>
                            <button class="btn quick-start-btn" onclick="askSample('Explain photosynthesis')" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(76,175,80,0.3); transition: all 0.3s ease;">
                                üå± Science
                            </button>
                            <button class="btn quick-start-btn" onclick="askSample('Help me write an essay')" style="background: linear-gradient(135deg, #6B35FF, #8b5aff); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(107,53,255,0.3); transition: all 0.3s ease;">
                                ‚úçÔ∏è Writing
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Enhanced Input Area -->
                <div class="input-area" style="padding: 20px; background: white; border-radius: 0 0 28px 28px;">
                    <div class="input-group input-group-lg" style="position: relative;">
                        <input type="text" class="form-control chat-input" id="kids-ai-input"
                               placeholder="‚ú® Ask me anything! Type your question here..."
                               style="border-radius: 25px; border: 3px solid rgba(107,53,255,0.2); font-size: 1.1rem; padding: 18px 24px; padding-right: 120px; box-shadow: 0 4px 15px rgba(107,53,255,0.1); transition: all 0.3s ease;"
                               onkeypress="if(event.key === 'Enter') sendKidsMessage()"
                               onfocus="this.style.borderColor='var(--dawn-purple)'; this.style.boxShadow='0 6px 20px rgba(107,53,255,0.2)'"
                               onblur="this.style.borderColor='rgba(107,53,255,0.2)'; this.style.boxShadow='0 4px 15px rgba(107,53,255,0.1)'">
                        <button class="btn btn-dawn send-button" onclick="sendKidsMessage()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border-radius: 20px; padding: 12px 28px; font-weight: 600; z-index: 10; box-shadow: 0 4px 15px rgba(255,107,53,0.3);">
                            <i class="bi bi-send-fill me-1"></i> Ask
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <small style="color: #999; font-size: 0.85rem;">
                            <i class="bi bi-shield-check text-success me-1"></i>
                            All conversations are monitored for safety
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Past Chats Section (for kids to see their history) -->
            {% if recent_conversations %}
            <div class="past-chats-card mb-4 animate-slide-in" style="background: linear-gradient(135deg, rgba(107,53,255,0.1), rgba(139,90,255,0.05)); border-radius: 25px; padding: 24px; box-shadow: 0 8px 25px rgba(107,53,255,0.2); border: 2px solid rgba(107,53,255,0.3); animation-delay: 0.4s;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold d-flex align-items-center" style="color: var(--dawn-dark); font-size: 1.3rem;">
                        <span style="font-size: 32px; margin-right: 12px;">üìö</span>
                        Your Past Chats
                    </h5>
                    <button class="btn btn-sm btn-dawn" onclick="startNewChat()" style="border-radius: 12px; padding: 8px 16px; font-size: 0.9rem; box-shadow: 0 3px 10px rgba(255,107,53,0.3);">
                        <i class="bi bi-plus-lg me-1"></i> New
                    </button>
                </div>
                <div class="past-chats-list" style="max-height: 300px; overflow-y: auto;">
                    {% for conversation in recent_conversations %}
                    <div class="chat-history-item p-3 mb-2" style="background: rgba(255,255,255,0.8); border-radius: 15px; border-left: 4px solid var(--dawn-purple); cursor: pointer; transition: all 0.3s ease;" onclick="loadConversation('{{ conversation.id }}', this)" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(107,53,255,0.2)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong style="color: var(--dawn-purple); font-size: 0.95rem;">{{ conversation.title|default:"Chat Session" }}</strong>
                            <small style="color: #999;">{{ conversation.created_at|date:"M d" }}</small>
                        </div>
                        <small style="color: #666;">{{ conversation.message_count|default:"0" }} messages</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Safety Info with Fun Design -->
            <div class="safety-card mb-4 animate-slide-in" style="background: linear-gradient(135deg, rgba(76,175,80,0.15), rgba(139,195,74,0.1)); border-radius: 25px; padding: 24px; box-shadow: 0 8px 25px rgba(76,175,80,0.2); border: 2px solid rgba(76,175,80,0.3); animation-delay: 0.6s;">
                <h5 class="mb-4 fw-bold d-flex align-items-center" style="color: var(--dawn-dark); font-size: 1.3rem;">
                    <span style="font-size: 32px; margin-right: 12px; animation: shield-pulse 2s ease-in-out infinite;">üõ°Ô∏è</span>
                    Safety Features
                </h5>
                <ul class="list-unstyled mb-0">
                    <li class="mb-3 d-flex align-items-start feature-item" style="animation: slide-in-left 0.5s ease-out 0.8s both;">
                        <div class="check-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(76,175,80,0.3);">
                            <i class="bi bi-check-lg" style="color: white; font-size: 18px; font-weight: bold;"></i>
                        </div>
                        <div>
                            <strong style="color: #2E7D32; font-size: 1.05rem;">Filtered Responses</strong>
                            <div class="small" style="color: #666;">No inappropriate content ever</div>
                        </div>
                    </li>
                    <li class="mb-3 d-flex align-items-start feature-item" style="animation: slide-in-left 0.5s ease-out 0.9s both;">
                        <div class="check-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(76,175,80,0.3);">
                            <i class="bi bi-check-lg" style="color: white; font-size: 18px; font-weight: bold;"></i>
                        </div>
                        <div>
                            <strong style="color: #2E7D32; font-size: 1.05rem;">Age-Appropriate</strong>
                            <div class="small" style="color: #666;">Answers match your age level</div>
                        </div>
                    </li>
                    <li class="mb-3 d-flex align-items-start feature-item" style="animation: slide-in-left 0.5s ease-out 1s both;">
                        <div class="check-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(76,175,80,0.3);">
                            <i class="bi bi-check-lg" style="color: white; font-size: 18px; font-weight: bold;"></i>
                        </div>
                        <div>
                            <strong style="color: #2E7D32; font-size: 1.05rem;">Parent Dashboard</strong>
                            <div class="small" style="color: #666;">Parents can see all chats</div>
                        </div>
                    </li>
                    <li class="d-flex align-items-start feature-item" style="animation: slide-in-left 0.5s ease-out 1.1s both;">
                        <div class="check-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(76,175,80,0.3);">
                            <i class="bi bi-check-lg" style="color: white; font-size: 18px; font-weight: bold;"></i>
                        </div>
                        <div>
                            <strong style="color: #2E7D32; font-size: 1.05rem;">100% Private</strong>
                            <div class="small" style="color: #666;">Stays on your Black Box</div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Quick Tips with Fun Animations -->
            <div class="tips-card mb-4 animate-slide-in" style="background: linear-gradient(135deg, rgba(255,193,7,0.15), rgba(255,235,59,0.1)); border-radius: 25px; padding: 24px; box-shadow: 0 8px 25px rgba(255,193,7,0.2); border: 2px solid rgba(255,193,7,0.3); animation-delay: 0.8s;">
                <h5 class="mb-4 fw-bold d-flex align-items-center" style="color: var(--dawn-dark); font-size: 1.3rem;">
                    <span style="font-size: 32px; margin-right: 12px; animation: lightbulb-glow 2s ease-in-out infinite;">üí°</span>
                    Quick Tips
                </h5>
                <div class="tip-item p-3 mb-3" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,140,90,0.05)); border-radius: 16px; border-left: 4px solid var(--dawn-orange); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(255,107,53,0.2)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                    <div class="d-flex align-items-center mb-1">
                        <span style="font-size: 24px; margin-right: 10px;">üìê</span>
                        <strong style="color: var(--dawn-orange); font-size: 1.05rem;">Math Problems</strong>
                    </div>
                    <div class="small" style="color: #666;">Show me your work and I'll help you understand</div>
                </div>
                <div class="tip-item p-3 mb-3" style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(102,187,106,0.05)); border-radius: 16px; border-left: 4px solid #4CAF50; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(76,175,80,0.2)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                    <div class="d-flex align-items-center mb-1">
                        <span style="font-size: 24px; margin-right: 10px;">üî¨</span>
                        <strong style="color: #2E7D32; font-size: 1.05rem;">Science Questions</strong>
                    </div>
                    <div class="small" style="color: #666;">Ask me to explain concepts simply</div>
                </div>
                <div class="tip-item p-3" style="background: linear-gradient(135deg, rgba(107,53,255,0.1), rgba(139,90,255,0.05)); border-radius: 16px; border-left: 4px solid var(--dawn-purple); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(107,53,255,0.2)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                    <div class="d-flex align-items-center mb-1">
                        <span style="font-size: 24px; margin-right: 10px;">‚úçÔ∏è</span>
                        <strong style="color: var(--dawn-purple); font-size: 1.05rem;">Writing Help</strong>
                    </div>
                    <div class="small" style="color: #666;">I can help with structure and ideas</div>
                </div>
            </div>

            <!-- Parent Controls (if admin) -->
            {% if family_member.role == 'admin' %}
            <div class="parent-controls-card mb-4 animate-slide-in" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,140,90,0.05)); border-radius: 25px; padding: 24px; box-shadow: 0 8px 25px rgba(255,107,53,0.2); border: 2px solid rgba(255,107,53,0.3); animation-delay: 1s;">
                <h5 class="mb-4 fw-bold d-flex align-items-center" style="color: var(--dawn-dark); font-size: 1.3rem;">
                    <span style="font-size: 32px; margin-right: 12px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    Parent Controls
                </h5>
                <a href="{% url 'vault_family_settings' %}" class="btn btn-outline-dawn btn-sm w-100 mb-2" style="border-radius: 15px; padding: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                    <i class="bi bi-people-fill"></i> Manage Family Members
                </a>
                <button class="btn btn-outline-dawn btn-sm w-100 mb-2" onclick="showConversationsModal()" style="border-radius: 15px; padding: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                    <i class="bi bi-eye"></i> View All Conversations
                </button>
                <button class="btn btn-outline-dawn btn-sm w-100" onclick="showStatsModal()" style="border-radius: 15px; padding: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                    <i class="bi bi-bar-chart"></i> View Learning Stats
                </button>
                <div class="mt-3 p-3" style="background: rgba(255,255,255,0.7); border-radius: 15px; border-left: 4px solid var(--dawn-orange);">
                    <small style="color: #666;">
                        <i class="bi bi-info-circle-fill" style="color: var(--dawn-orange);"></i>
                        <strong>All chat activity is logged and monitored for safety.</strong>
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let currentConversation = null;

function sendKidsMessage() {
    const input = document.getElementById('kids-ai-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);

    // Clear input
    input.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Include conversation ID if continuing a past chat
    const requestBody = { message: message };
    if (currentConversation) {
        requestBody.conversation_id = currentConversation;
    }

    // Call backend API
    fetch('/kids-ai/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();

        if (data.success) {
            addMessageToChat('ai', data.response);

            // Update current conversation ID if returned (for new conversations)
            if (data.conversation_id) {
                currentConversation = data.conversation_id;
            }

            // Show indicator if in mock mode
            if (data.mock_mode) {
                addSystemMessage('üí° Using demo mode (Ollama not running). Responses are pre-written examples.');
            }
        } else {
            addMessageToChat('ai', '‚ùå Sorry, I had trouble understanding that. Can you try asking in a different way?');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Error:', error);
        addMessageToChat('ai', '‚ùå Oops! Something went wrong. Please try again.');
    });
}

function addMessageToChat(type, message) {
    const chatContainer = document.getElementById('chat-messages');

    // Remove welcome message if exists
    if (chatContainer.querySelector('.text-center.py-5')) {
        chatContainer.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 chat-message ${type === 'user' ? 'text-end' : ''}`;

    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="d-inline-block p-3" style="background: linear-gradient(135deg, var(--dawn-orange), #ff8c5a); color: white; border-radius: 20px 20px 4px 20px; max-width: 70%; box-shadow: 0 4px 15px rgba(255,107,53,0.3); font-size: 1.05rem; line-height: 1.5;">
                ${escapeHtml(message)}
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="robot-avatar" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--dawn-purple), #8b5aff); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 14px; flex-shrink: 0; box-shadow: 0 4px 15px rgba(107,53,255,0.3); animation: bounce-slow 3s ease-in-out infinite;">
                    <i class="bi bi-robot" style="color: white; font-size: 24px;"></i>
                </div>
                <div class="p-3" style="background: linear-gradient(135deg, #ffffff, #f8f9ff); border-radius: 20px 20px 20px 4px; max-width: 70%; border: 2px solid rgba(107,53,255,0.15); box-shadow: 0 4px 15px rgba(107,53,255,0.1); font-size: 1.05rem; line-height: 1.6; color: #333;">
                    ${escapeHtml(message)}
                </div>
            </div>
        `;
    }

    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showTypingIndicator() {
    const chatContainer = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'mb-3 chat-message';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="robot-avatar" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--dawn-purple), #8b5aff); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 14px; flex-shrink: 0; box-shadow: 0 4px 15px rgba(107,53,255,0.3); animation: bounce-slow 3s ease-in-out infinite;">
                <i class="bi bi-robot" style="color: white; font-size: 24px;"></i>
            </div>
            <div class="p-3 typing-bubble" style="background: linear-gradient(135deg, #ffffff, #f8f9ff); border-radius: 20px 20px 20px 4px; border: 2px solid rgba(107,53,255,0.15); box-shadow: 0 4px 15px rgba(107,53,255,0.1); min-width: 80px;">
                <div class="d-flex align-items-center gap-2">
                    <div class="typing-dot" style="width: 10px; height: 10px; background: var(--dawn-purple); border-radius: 50%; animation: typing-dots 1.4s ease-in-out infinite;"></div>
                    <div class="typing-dot" style="width: 10px; height: 10px; background: var(--dawn-purple); border-radius: 50%; animation: typing-dots 1.4s ease-in-out infinite 0.2s;"></div>
                    <div class="typing-dot" style="width: 10px; height: 10px; background: var(--dawn-purple); border-radius: 50%; animation: typing-dots 1.4s ease-in-out infinite 0.4s;"></div>
                    <span class="ms-2" style="color: var(--dawn-purple); font-size: 0.95rem; font-weight: 500;">Thinking...</span>
                </div>
            </div>
        </div>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
}

function getMockResponse(message) {
    const lower = message.toLowerCase();

    if (lower.includes('math') || lower.includes('homework')) {
        return "I'd be happy to help with your math! Can you show me the specific problem you're working on? Remember to show your work so I can help you understand each step!";
    } else if (lower.includes('science') || lower.includes('photosynthesis')) {
        return "Great question! Photosynthesis is how plants make their food using sunlight. Think of it like a plant's kitchen - they take in sunlight, water, and carbon dioxide, and make sugar (their food) and oxygen (which we breathe). Pretty cool, right?";
    } else if (lower.includes('essay') || lower.includes('writing')) {
        return "I can help you organize your essay! Let's start with these questions: What's your topic? What's your main idea? And what are 3 points you want to make? Once we have that, we can build a great outline together!";
    } else {
        return `That's an interesting question! I'm here to help you learn. Can you tell me more about what you're trying to understand? Remember, it's okay to ask questions - that's how we learn!`;
    }
}

function askSample(question) {
    document.getElementById('kids-ai-input').value = question;
    sendKidsMessage();
}

function addSystemMessage(message) {
    const chatContainer = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'mb-3 text-center';
    msgDiv.innerHTML = `
        <small class="badge" style="background: rgba(255,193,7,0.2); color: #666; padding: 8px 16px; border-radius: 20px;">
            ${message}
        </small>
    `;
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function startNewChat() {
    // Reset current conversation
    currentConversation = null;

    // Clear chat container
    const chatContainer = document.getElementById('chat-messages');
    chatContainer.innerHTML = `
        <div class="text-center py-5 animate-fade-in">
            <div class="welcome-icon" style="font-size: 80px; animation: bounce-slow 3s ease-in-out infinite;">üí¨</div>
            <h5 class="mt-4 fw-bold" style="color: var(--dawn-purple); font-size: 1.8rem;">Ready for a new chat! üëã</h5>
            <p class="text-muted" style="font-size: 1.1rem;">Ask me anything about homework!</p>
            <div class="d-flex gap-3 justify-content-center flex-wrap mt-4">
                <button class="btn quick-start-btn" onclick="askSample('Help me with math homework')" style="background: linear-gradient(135deg, #FF6B35, #ff8c5a); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(255,107,53,0.3); transition: all 0.3s ease;">
                    üìê Math Help
                </button>
                <button class="btn quick-start-btn" onclick="askSample('Explain photosynthesis')" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(76,175,80,0.3); transition: all 0.3s ease;">
                    üå± Science
                </button>
                <button class="btn quick-start-btn" onclick="askSample('Help me write an essay')" style="background: linear-gradient(135deg, #6B35FF, #8b5aff); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(107,53,255,0.3); transition: all 0.3s ease;">
                    ‚úçÔ∏è Writing
                </button>
            </div>
        </div>
    `;

    // Reset all chat history highlighting
    document.querySelectorAll('.chat-history-item').forEach(item => {
        item.style.borderLeft = '4px solid var(--dawn-purple)';
    });

    showNotification('‚ú® Started new chat session!', 'success');
}

function loadConversation(conversationId, element) {
    console.log('Loading conversation:', conversationId);

    // Fetch and display past conversation
    fetch(`/kids-ai/conversation/${conversationId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Conversation data:', data);

        if (data.success) {
            // Set current conversation ID so new messages continue this chat
            currentConversation = conversationId;
            console.log('Set currentConversation to:', currentConversation);

            // Clear chat and load conversation history
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';

            // Add all past messages
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addMessageToChat(msg.role === 'user' ? 'user' : 'ai', msg.content);
                });
            } else {
                chatContainer.innerHTML = '<div class="text-center py-5"><p class="text-muted">No messages in this conversation yet.</p></div>';
            }

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Highlight the active chat in sidebar
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.style.borderLeft = '4px solid var(--dawn-purple)';
            });
            if (element) {
                element.style.borderLeft = '6px solid var(--dawn-orange)';
                element.style.background = 'rgba(255,107,53,0.1)';
            }

            showNotification(`‚úÖ Loaded "${data.conversation_title}" - You can continue chatting!`, 'success');
        } else {
            showNotification('‚ùå Could not load conversation', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading conversation:', error);
        showNotification('‚ùå Could not load conversation', 'error');
    });
}

// Parental Control Functions
function showConversationsModal() {
    {% if family_member.role == 'admin' and all_conversations %}
    const modalHTML = `
        <div class="modal fade" id="conversationsModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content" style="border-radius: 20px; border: 2px solid rgba(107,53,255,0.2);">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--dawn-purple), #8b5aff); color: white; border-radius: 18px 18px 0 0;">
                        <h5 class="modal-title"><i class="bi bi-eye-fill me-2"></i>All Family Conversations</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px;">
                        {% for conv in all_conversations %}
                        <div class="conversation-item p-3 mb-3" style="background: linear-gradient(135deg, rgba(107,53,255,0.05), rgba(255,255,255,0.8)); border-radius: 15px; border-left: 4px solid var(--dawn-purple);">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong style="color: var(--dawn-purple);">{{ conv.user.username }}</strong>
                                    <span class="badge ms-2" style="background: rgba(107,53,255,0.2); color: var(--dawn-purple);">{{ conv.message_count|default:"0" }} msgs</span>
                                </div>
                                <small style="color: #999;">{{ conv.created_at|date:"M d, Y H:i" }}</small>
                            </div>
                            <div style="color: #666; font-size: 0.95rem;">
                                <strong>Title:</strong> {{ conv.title|default:"Chat Session" }}
                            </div>
                            <button class="btn btn-sm btn-outline-dawn mt-2" onclick="viewConversationDetails('{{ conv.id }}')" style="border-radius: 10px;">
                                <i class="bi bi-eye"></i> View Details
                            </button>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <p style="color: #999;">No conversations yet</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer" style="border-radius: 0 0 18px 18px;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('conversationsModal');
    if (existingModal) existingModal.remove();

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('conversationsModal'));
    modal.show();
    {% else %}
    showNotification('üìä No conversations to display yet', 'info');
    {% endif %}
}

function viewConversationDetails(conversationId) {
    // Fetch detailed conversation messages
    fetch(`/kids-ai/conversation/${conversationId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let messagesHTML = '';
            data.messages.forEach(msg => {
                const isUser = msg.role === 'user';
                messagesHTML += `
                    <div class="message-detail mb-3 ${isUser ? 'text-end' : ''}">
                        <div class="d-inline-block p-3" style="background: ${isUser ? 'linear-gradient(135deg, var(--dawn-orange), #ff8c5a)' : 'linear-gradient(135deg, #ffffff, #f8f9ff)'}; color: ${isUser ? 'white' : '#333'}; border-radius: 15px; max-width: 80%; text-align: left; border: ${isUser ? 'none' : '2px solid rgba(107,53,255,0.1)'};">
                            <strong>${isUser ? 'Child' : 'AI Tutor'}:</strong>
                            <div class="mt-1">${escapeHtml(msg.content)}</div>
                            <small style="opacity: 0.7; font-size: 0.8rem;">${msg.timestamp || ''}</small>
                        </div>
                    </div>
                `;
            });

            const detailModalHTML = `
                <div class="modal fade" id="conversationDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content" style="border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, var(--dawn-orange), #ff8c5a); color: white; border-radius: 18px 18px 0 0;">
                                <h5 class="modal-title"><i class="bi bi-chat-dots-fill me-2"></i>Conversation Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="max-height: 500px; background: linear-gradient(180deg, #f8f9ff 0%, #fff 100%);">
                                ${messagesHTML}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing detail modal
            const existingDetailModal = document.getElementById('conversationDetailModal');
            if (existingDetailModal) existingDetailModal.remove();

            document.body.insertAdjacentHTML('beforeend', detailModalHTML);
            const detailModal = new bootstrap.Modal(document.getElementById('conversationDetailModal'));
            detailModal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ùå Could not load conversation details', 'error');
    });
}

function showStatsModal() {
    {% if family_member.role == 'admin' %}
    // Calculate stats from conversations
    const totalConvs = {{ all_conversations|length|default:0 }};
    const statsHTML = `
        <div class="modal fade" id="statsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="border-radius: 20px; border: 2px solid rgba(76,175,80,0.2);">
                    <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; border-radius: 18px 18px 0 0;">
                        <h5 class="modal-title"><i class="bi bi-bar-chart-fill me-2"></i>Learning Statistics</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="stat-card p-4" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,140,90,0.05)); border-radius: 15px; border-left: 4px solid var(--dawn-orange);">
                                    <h3 class="mb-2" style="color: var(--dawn-orange); font-weight: bold;">${totalConvs}</h3>
                                    <p class="mb-0" style="color: #666;">Total Conversations</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stat-card p-4" style="background: linear-gradient(135deg, rgba(107,53,255,0.1), rgba(139,90,255,0.05)); border-radius: 15px; border-left: 4px solid var(--dawn-purple);">
                                    <h3 class="mb-2" style="color: var(--dawn-purple); font-weight: bold;">{{ all_conversations|length }}</h3>
                                    <p class="mb-0" style="color: #666;">Active Learning Sessions</p>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="stat-card p-4" style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(139,195,74,0.05)); border-radius: 15px; border-left: 4px solid #4CAF50;">
                                    <h5 class="mb-3" style="color: #2E7D32;"><i class="bi bi-trophy-fill me-2"></i>Recent Activity</h5>
                                    <ul class="list-unstyled mb-0">
                                        {% for conv in all_conversations|slice:":5" %}
                                        <li class="mb-2">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <strong>{{ conv.user.username }}</strong> - {{ conv.created_at|timesince }} ago
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3" style="background: rgba(255,193,7,0.1); border-radius: 15px; border-left: 4px solid #FFC107;">
                            <p class="mb-0" style="color: #666;">
                                <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                                <strong>Tip:</strong> Regular engagement with the AI tutor helps build consistent learning habits!
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingStatsModal = document.getElementById('statsModal');
    if (existingStatsModal) existingStatsModal.remove();

    document.body.insertAdjacentHTML('beforeend', statsHTML);
    const modal = new bootstrap.Modal(document.getElementById('statsModal'));
    modal.show();
    {% else %}
    showNotification('üìà Stats available for parents only', 'info');
    {% endif %}
}

function showNotification(message, type = 'info') {
    const colors = {
        success: '#4CAF50',
        error: '#f44336',
        info: '#2196F3'
    };

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
        font-weight: 500;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>

<style>
/* ==================== AMAZING ANIMATIONS ==================== */

/* Floating Animation for Emojis */
@keyframes float {
    0%, 100% {
        transform: translateY(0px) rotate(0deg);
    }
    50% {
        transform: translateY(-20px) rotate(5deg);
    }
}

/* Bouncing Robot */
@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

/* Slower Bounce for Welcome Icon */
@keyframes bounce-slow {
    0%, 100% {
        transform: translateY(0) scale(1);
    }
    50% {
        transform: translateY(-15px) scale(1.05);
    }
}

/* Badge Bounce Effect */
@keyframes badge-bounce {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Wiggle Animation */
@keyframes wiggle {
    0%, 100% {
        transform: rotate(0deg);
    }
    25% {
        transform: rotate(-5deg);
    }
    75% {
        transform: rotate(5deg);
    }
}

/* Shield Pulse */
@keyframes shield-pulse {
    0%, 100% {
        transform: scale(1);
        filter: drop-shadow(0 0 0 rgba(76,175,80,0));
    }
    50% {
        transform: scale(1.1);
        filter: drop-shadow(0 0 10px rgba(76,175,80,0.5));
    }
}

/* Lightbulb Glow */
@keyframes lightbulb-glow {
    0%, 100% {
        filter: brightness(1) drop-shadow(0 0 0 rgba(255,193,7,0));
    }
    50% {
        filter: brightness(1.3) drop-shadow(0 0 10px rgba(255,193,7,0.8));
    }
}

/* Slide In from Right */
@keyframes animate-slide-in {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Slide In from Left */
@keyframes slide-in-left {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Fade In */
@keyframes animate-fade-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Pulse for Buttons */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 6px 20px rgba(255,107,53,0.4);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 8px 30px rgba(255,107,53,0.6);
    }
}

/* Gradient Shift Background */
@keyframes gradient-shift {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

/* Message Slide In */
@keyframes message-slide-in {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Typing Dots Animation */
@keyframes typing-dots {
    0%, 20% {
        opacity: 0.2;
    }
    50% {
        opacity: 1;
    }
    100% {
        opacity: 0.2;
    }
}

/* Apply Animation Classes */
.animate-slide-in {
    animation: animate-slide-in 0.6s ease-out both;
}

.animate-fade-in {
    animation: animate-fade-in 0.6s ease-out both;
}

.pulse-button {
    animation: pulse 2s ease-in-out infinite;
}

.pulse-button:hover {
    animation: none;
    transform: scale(1.05) translateY(-2px);
    box-shadow: 0 10px 35px rgba(255,107,53,0.5) !important;
}

/* Hero Card Styling */
.kids-hero-card {
    border-radius: 30px;
    padding: 40px;
    transition: all 0.3s ease;
    animation: animate-fade-in 0.8s ease-out;
}

/* Quick Start Buttons Hover */
.quick-start-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
}

/* Feature Item Hover */
.feature-item:hover .check-icon {
    transform: rotate(360deg) scale(1.1);
    transition: transform 0.6s ease;
}

/* Chat Message Animations */
.chat-message {
    animation: message-slide-in 0.4s ease-out;
}

/* Send Button Hover */
.send-button:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 25px rgba(255,107,53,0.5) !important;
}

/* Input Focus Glow */
.chat-input:focus {
    animation: input-glow 0.3s ease-out;
}

@keyframes input-glow {
    0% {
        box-shadow: 0 4px 15px rgba(107,53,255,0.1);
    }
    100% {
        box-shadow: 0 6px 20px rgba(107,53,255,0.2);
    }
}

/* Smooth Scrolling */
#chat-messages {
    scroll-behavior: smooth;
}

/* Custom Scrollbar */
#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: rgba(107,53,255,0.05);
    border-radius: 10px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--dawn-purple), var(--dawn-orange));
    border-radius: 10px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--dawn-orange), var(--dawn-purple));
}

/* Sparkle Effect on Hover */
.sparkle-on-hover {
    position: relative;
    overflow: hidden;
}

.sparkle-on-hover::after {
    content: '‚ú®';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 24px;
    opacity: 0;
    transition: all 0.3s ease;
}

.sparkle-on-hover:hover::after {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

/* Notification Slide Animations */
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* Past Chats Custom Scrollbar */
.past-chats-list::-webkit-scrollbar {
    width: 6px;
}

.past-chats-list::-webkit-scrollbar-track {
    background: rgba(107,53,255,0.05);
    border-radius: 10px;
}

.past-chats-list::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--dawn-purple), var(--dawn-orange));
    border-radius: 10px;
}

.past-chats-list::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--dawn-orange), var(--dawn-purple));
}

/* Responsive Animations */
@media (max-width: 768px) {
    .floating-emoji {
        font-size: 24px !important;
    }

    .kids-hero-card {
        padding: 24px;
    }
}

/* Loading Spinner for Chat */
@keyframes spinner {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.loading-spinner {
    border: 3px solid rgba(107,53,255,0.1);
    border-top: 3px solid var(--dawn-purple);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spinner 0.8s linear infinite;
}
</style>
{% endblock %}
